新版計畫：用戶自訂資料源 (個人知識庫)
1. 功能概述
實現用戶私有知識庫管理，允許用戶上傳個人文件（PDF, Word, Text, URL）並與公共數據進行混合檢索，正式賦予產品「公共+私有」雙軌檢索能力。

2. 架構設計
2.1. 數據存儲架構
數據庫整合: 新的元數據表將被整合到現有的 Analytics Database 中，以重用其成熟的SQLite/PostgreSQL雙後端支持能力 (core/analytics_db.py)。
新增資料表 (Schema):
user_sources: 存儲用戶上傳的資料源元數據。
source_id (PK), user_id (FK), name, file_type, status, created_at, updated_at
user_documents: 存儲已解析文檔的元數據。
doc_id (PK), source_id (FK), checksum, chunk_count, processed_at
user_chunks: 存儲文本分塊的內容，用於重建上下文。
chunk_id (PK), doc_id (FK), content, metadata (如頁碼)
向量索引:
Qdrant: 重用現有的 Qdrant 向量資料庫。
數據隔離: 透過為每個用戶創建獨立的 Collection（命名空間）來實現，例如 user_{user_id}_{source_id}，確保數據的絕對隔離。
2.2. 處理管道
與原計劃相同，流程清晰，保持不變： 上傳 → 解析 → 分塊 → 嵌入 → 索引 → 檢索整合

3. API 設計
RESTful API 設計與原計劃相同，符合現有 /api/... 風格：

資料源管理:
POST /api/user/sources: 創建資料源。
GET /api/user/sources: 列出用戶所有資料源。
DELETE /api/user/sources/{id}: 刪除指定資料源及其所有數據。
POST /api/user/sources/{id}/reindex: 觸發對指定資料源的重新分析和索引。
文件上傳:
POST /api/user/upload: 上傳文件 (multipart/form-data)。
GET /api/user/upload/{id}/status: 查詢異步上傳和處理的狀態。
檢索 API 擴展:
擴展現有 /ask API，新增 include_private_sources: bool 參數。
4. 實現組件
文件解析器 (core/parsers/): 創建一個工廠模式的解析器，根據文件類型（pdf, docx, txt, url）動態選擇 PyPDF2, python-docx 等具體實現。
文本分塊器 (core/chunking/): 實現可配置的分塊策略（如固定長度、語義分塊）。
用戶數據管理器 (core/user_data_manager.py): 核心服務類，封裝用戶數據的增刪改查（CRUD）邏輯。
檢索架構 (Retrieval Architecture):
UserQdrantProvider (retrieval_providers/user_qdrant_provider.py):
創建一個新的 RetrievalProvider，專門用於查詢用戶的私有 Qdrant Collection。它將根據傳入的 user_id 動態確定要查詢的 Collection 名稱。
EnsembleRetriever (retrieval/ensemble_retriever.py):
一個更高層的檢索器，它將是 NLWebHandler 的主要入口。
它會根據 include_private_sources 參數，決定是只調用公共的 QdrantRetrievalProvider，還是並行調用公共和私有的 Provider，然後將兩組結果合併、去重並交給後續的排序模塊。
5. 分析與監控整合 (Analytics & Monitoring)
這是新版計劃的關鍵。為充分利用現有強大的分析能力，新功能的所有關鍵活動都必須整合到 core/query_logger.py 中。

Schema 擴展:
修改 retrieved_documents 表，新增一個 source_type 欄位 (e.g., 'public', 'private')。
日誌記錄點:
上傳與處理: 記錄文件上傳的完整生命週期，包括成功、失敗、解析耗時、分塊數量等，可存入新的 user_log 表或擴展現有日誌。
私有數據檢索: 當 EnsembleRetriever 從 UserQdrantProvider 獲取到結果時，QueryLogger 需將這些結果連同 query_id 一起記錄到 retrieved_documents 表，並將 source_type 標記為 'private'。
用戶交互: 現有的點擊、滾動等前端事件追蹤無需修改，因為它們是基於 doc_url 的，QueryLogger 會自動將其與 'private' 的文檔關聯起來。
目的: 確保私有知識庫的數據使用情況能被納入 XGBoost 等模型的未來訓練中，以優化混合檢索的排序效果。
###6. UI/UX設計 與原計劃相同，專注於無縫整合：

管理界面: 在側邊欄新增「我的知識庫」入口，提供拖拽上傳、列表管理、狀態監控等功能。
搜索界面: 在主搜索框旁新增「包含我的知識庫」開關，並在搜索結果中對來自私有知識庫的內容進行特殊標記。
7. 安全與權限
保持原計劃的嚴格設計：

API 級別: 所有 /api/user/* 端點都必須驗證 OAuth Token 中的 user_id。
存儲級別: 在 Qdrant 中使用以 user_id 為前綴的 Collection 名稱，從物理層面隔離數據。
資源限制: 在 config/user_data.yaml 中配置每個用戶可上傳的總大小、文件數量等配額。
8. 實現步驟 (Phases)
Phase 1: 基礎架構 (2週)
在 core/analytics_db.py 中定義新的數據庫表 Schema。
創建 core/user_data_manager.py 的基本框架。
實現 core/parsers/ 中的文件解析器。
添加 /api/user/sources 和 /api/user/upload 的基本端點。
Phase 2: 處理管道 (2週)
實現 core/chunking/ 中的文本分塊 logique。
集成現有的 embedding 生成能力。
實現異步化的索引流程，並更新上傳狀態。
整合分析日誌：記錄上傳和處理過程。
Phase 3: 檢索整合 (1-2週)
實現 UserQdrantProvider。
實現 EnsembleRetriever，完成雙軌查詢與結果合併。
擴展 /ask API。
整合分析日誌: 記錄私有數據的檢索事件。
Phase 4: UI 與測試 (2週)
開發前端「我的知識庫」管理界面。
在主搜索頁面添加切換開關和結果標記。
編寫單元測試、集成測試和 E2E 測試。
9. 依賴與兼容性
與原計劃相同，主要新增 PyPDF2, python-docx, beautifulsoup4 等庫。

這個新版計劃最大程度地重用了您現有的架構優勢（特別是數據庫和分析層），確保新功能不僅是一個外掛模塊，而是深度融入系統生態的「一等公民」。

Generated by Gemini gemini-2.5-pro

Owen Kuo
