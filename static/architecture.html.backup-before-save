<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NLWeb System Architecture</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1900px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .controls {
            padding: 20px 30px;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        .workflow-btn, .edit-btn, .add-btn, .export-btn {
            padding: 10px 20px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95em;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .workflow-btn:hover, .edit-btn:hover, .add-btn:hover, .export-btn:hover {
            background: #667eea;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .workflow-btn.active {
            background: #667eea;
            color: white;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .edit-btn.active {
            background: #28a745;
            border-color: #28a745;
            color: white;
        }

        .add-btn {
            display: none;
            background: #17a2b8;
            border-color: #17a2b8;
            color: white;
        }

        .add-btn.visible {
            display: inline-block;
        }

        .export-btn {
            border-color: #ffc107;
            color: #856404;
        }

        .export-btn:hover {
            background: #ffc107;
            color: #856404;
        }

        .spacer {
            flex: 1;
        }

        .legend {
            display: flex;
            gap: 15px;
            padding: 10px 30px;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            font-size: 0.9em;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .legend-box {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            border: 2px solid #333;
        }

        .legend-box.done {
            background: #4CAF50;
        }

        .legend-box.partial {
            background: #FFC107;
        }

        .legend-box.notdone {
            background: #F44336;
        }

        .legend-box.header {
            background: #9C27B0;
        }

        .main-content {
            display: flex;
            height: calc(100vh - 300px);
            min-height: 600px;
        }

        .canvas-container {
            flex: 1;
            position: relative;
            overflow: auto;
            background: #ffffff;
        }

        #dag-canvas {
            width: 100%;
            height: 100%;
            min-width: 4500px;
            min-height: 1500px;
        }

        .node {
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .node.draggable {
            cursor: move;
        }

        .node-rect {
            stroke-width: 2;
            rx: 8;
            transition: all 0.3s ease;
        }

        .node-rect.status-done {
            fill: #4CAF50;
            stroke: #2e7d32;
        }

        .node-rect.status-partial {
            fill: #FFC107;
            stroke: #f57f17;
        }

        .node-rect.status-notdone {
            fill: #F44336;
            stroke: #c62828;
        }

        .node-rect.status-header {
            fill: #9C27B0;
            stroke: #6a1b9a;
        }

        .node:hover .node-rect {
            filter: brightness(1.1);
            stroke-width: 3;
        }

        .node-text {
            fill: white;
            font-size: 14px;
            font-weight: 600;
            pointer-events: none;
            user-select: none;
        }

        .node-script {
            fill: rgba(255, 255, 255, 0.8);
            font-size: 11px;
            pointer-events: none;
            user-select: none;
        }

        .edit-icon {
            cursor: pointer;
            display: none;
        }

        .edit-mode .edit-icon {
            display: block;
        }

        .edit-circle {
            fill: white;
            stroke: #667eea;
            stroke-width: 2;
        }

        .edit-circle:hover {
            fill: #667eea;
        }

        .edit-text {
            fill: #667eea;
            font-size: 12px;
            font-weight: bold;
            pointer-events: none;
        }

        .edit-circle:hover + .edit-text {
            fill: white;
        }

        .edge {
            fill: none;
            stroke: #667eea;
            stroke-width: 2;
            marker-end: url(#arrowhead);
            transition: all 0.3s ease;
        }

        .edge.clickable {
            cursor: pointer;
            stroke-width: 4;
        }

        .edge.clickable:hover {
            stroke: #ff6b6b;
            stroke-width: 5;
        }

        .node.selected .node-rect {
            stroke: #ffd700;
            stroke-width: 4;
            filter: drop-shadow(0 0 10px #ffd700);
        }

        .module-box {
            fill: none;
            stroke: #9C27B0;
            stroke-width: 3;
            stroke-dasharray: 10, 5;
            opacity: 0.5;
            rx: 12;
        }

        .module-box.draggable {
            cursor: move;
        }

        .module-box.draggable:hover {
            opacity: 0.8;
            stroke-width: 4;
        }

        .resize-handle {
            fill: #9C27B0;
            stroke: white;
            stroke-width: 2;
            cursor: nwse-resize;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .module-box-group:hover .resize-handle {
            opacity: 0.8;
        }

        .resize-handle:hover {
            opacity: 1;
            fill: #7B1FA2;
        }

        .info-panel {
            position: absolute;
            background: white;
            border: 2px solid #667eea;
            border-radius: 12px;
            padding: 20px;
            max-width: 400px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            display: none;
        }

        .info-panel.visible {
            display: block;
        }

        .info-panel h3 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 1.3em;
        }

        .info-panel p {
            color: #555;
            line-height: 1.6;
            font-size: 0.95em;
            white-space: pre-wrap;
        }

        .info-panel .close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .info-panel .close-btn:hover {
            background: #c82333;
            transform: rotate(90deg);
        }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .modal-overlay.visible {
            display: flex;
        }

        .modal {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .modal h2 {
            color: #667eea;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
            font-family: inherit;
        }

        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .checkbox-item input[type="checkbox"] {
            width: auto;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            justify-content: flex-end;
        }

        .modal-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .modal-btn.save {
            background: #28a745;
            color: white;
        }

        .modal-btn.save:hover {
            background: #218838;
        }

        .modal-btn.cancel {
            background: #6c757d;
            color: white;
        }

        .modal-btn.cancel:hover {
            background: #5a6268;
        }

        .modal-btn.delete {
            background: #dc3545;
            color: white;
            margin-right: auto;
        }

        .modal-btn.delete:hover {
            background: #c82333;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>NLWeb System Architecture</h1>
            <p>Interactive Architecture Visualization - Click nodes to explore</p>
        </div>
        <div class="controls">
            <strong>Workflows:</strong>
            <button class="workflow-btn" data-workflow="workflow1">å®Œæ•´éè¿´æ¨è«–æµç¨‹</button>
            <button class="workflow-btn" data-workflow="workflow2">è³‡æ–™ç´¢å¼•èˆ‡æª¢ç´¢æµç¨‹</button>
            <button class="workflow-btn" data-workflow="workflow3">æ’åºèˆ‡æ¨è«–æµç¨‹</button>
            <button class="workflow-btn" data-workflow="workflow4">ç³»çµ±æ¶æ§‹èˆ‡æ•¸æ“šæµ</button>
            <button class="workflow-btn active" data-workflow="workflow5">ç³»çµ±å…¨è²Œ</button>
            <span class="spacer"></span>
            <button class="edit-btn" id="edit-mode-btn">ğŸ–Šï¸ ç·¨è¼¯æ¨¡å¼</button>
            <button class="add-btn" id="add-node-btn">â• æ–°å¢ç¯€é»</button>
            <button class="add-btn" id="save-layout-btn">ğŸ’¾ å„²å­˜ä½ˆå±€åˆ° HTML</button>
            <button class="export-btn" id="import-btn">ğŸ“¤ åŒ¯å…¥ JSON</button>
            <button class="export-btn" id="export-btn">ğŸ“¥ åŒ¯å‡º JSON</button>
            <input type="file" id="import-file-input" accept=".json" style="display: none;">
        </div>
        <div class="legend">
            <div class="legend-item">
                <div class="legend-box done"></div>
                <span>Done (å®Œæˆ)</span>
            </div>
            <div class="legend-item">
                <div class="legend-box partial"></div>
                <span>Partial (éƒ¨åˆ†å®Œæˆ)</span>
            </div>
            <div class="legend-item">
                <div class="legend-box notdone"></div>
                <span>Not Done (æœªå®Œæˆ)</span>
            </div>
            <div class="legend-item">
                <div class="legend-box header"></div>
                <span>Module Header (æ¨¡çµ„æ¨™é¡Œ)</span>
            </div>
        </div>
        <div class="main-content">
            <div class="canvas-container">
                <svg id="dag-canvas">
                    <defs>
                        <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
                            <polygon points="0 0, 10 3, 0 6" fill="#667eea" />
                        </marker>
                    </defs>
                    <g id="module-boxes-group"></g>
                    <g id="edges-group"></g>
                    <g id="nodes-group"></g>
                </svg>
                <div id="info-panel" class="info-panel">
                    <button class="close-btn" onclick="closeInfoPanel()">Ã—</button>
                    <h3 id="info-title">Node Name</h3>
                    <p id="info-content">Details will appear here...</p>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="edit-modal">
        <div class="modal">
            <h2 id="modal-title">ç·¨è¼¯ç¯€é»</h2>
            <form id="edit-form">
                <div class="form-group">
                    <label>è‹±æ–‡æ¨™é¡Œ (labelEn) *</label>
                    <input type="text" id="input-labelEn" required>
                </div>
                <div class="form-group">
                    <label>ä¸­æ–‡æ¨™é¡Œ (labelZh) *</label>
                    <input type="text" id="input-labelZh" required>
                </div>
                <div class="form-group">
                    <label>å¯¦ä½œç‹€æ…‹ (status) *</label>
                    <select id="input-status" required>
                        <option value="done">Done (å®Œæˆ)</option>
                        <option value="partial">Partial (éƒ¨åˆ†å®Œæˆ)</option>
                        <option value="notdone">Not Done (æœªå®Œæˆ)</option>
                        <option value="header">Header (æ¨¡çµ„æ¨™é¡Œ)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>è…³æœ¬è·¯å¾‘ (script)</label>
                    <input type="text" id="input-script" placeholder="e.g., core/ranking.py">
                </div>
                <div class="form-group" id="module-group">
                    <label>æ‰€å±¬æ¨¡çµ„ (moduleId)</label>
                    <select id="input-moduleId">
                    </select>
                </div>
                <div class="form-group">
                    <label>è¨­è¨ˆèªªæ˜ (rationale)</label>
                    <textarea id="input-rationale" placeholder="è«‹è¼¸å…¥è¨­è¨ˆèªªæ˜èˆ‡å¯¦ä½œç´°ç¯€..."></textarea>
                </div>
                <div class="form-group">
                    <label>Workflows</label>
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="checkbox" id="wf1" value="workflow1">
                            <label for="wf1">workflow1: å®Œæ•´éè¿´æ¨è«–æµç¨‹</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="wf2" value="workflow2">
                            <label for="wf2">workflow2: è³‡æ–™ç´¢å¼•èˆ‡æª¢ç´¢æµç¨‹</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="wf3" value="workflow3">
                            <label for="wf3">workflow3: æ’åºèˆ‡æ¨è«–æµç¨‹</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="wf4" value="workflow4">
                            <label for="wf4">workflow4: ç³»çµ±æ¶æ§‹èˆ‡æ•¸æ“šæµ</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="wf5" value="workflow5">
                            <label for="wf5">workflow5: ç³»çµ±å…¨è²Œï¼ˆé è¨­ï¼‰</label>
                        </div>
                    </div>
                </div>
                <div class="modal-buttons">
                    <button type="button" class="modal-btn delete" id="delete-btn">ğŸ—‘ï¸ åˆªé™¤ç¯€é»</button>
                    <button type="button" class="modal-btn cancel" id="cancel-btn">âœ— å–æ¶ˆ</button>
                    <button type="submit" class="modal-btn save">âœ“ å„²å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let graphData = null;
        let currentWorkflow = 'workflow5';
        let editMode = false;
        let currentEditNode = null;
        let draggedNode = null;
        let dragOffset = { x: 0, y: 0 };
        let selectedNodeForEdge = null;  // For edge creation

        const config = {
            nodeWidth: 200,
            nodeHeight: 100
        };

        // Load JSON data from architecture-diagram.json
        graphData = {
  "nodes": [
    {
      "id": "mod-indexing",
      "labelEn": "Indexing",
      "labelZh": "ç´¢å¼•èˆ‡æ•¸æ“š",
      "moduleId": 0,
      "status": "header",
      "rationale": "Indexing æ¨¡çµ„æ˜¯æ”¯æ’ç³»çµ±é‹ä½œçš„ã€Œé«˜å¯ä¿¡è³‡æ–™å·¥å» ã€ã€‚ä¸åŒæ–¼ä¸€èˆ¬è³‡æ–™åº«åªè² è²¬å­˜å„²ï¼Œæœ¬æ¨¡çµ„æ¶µè“‹äº†å¾è‡ªå‹•åŒ–æ“·å–ã€æ¸…æ´—ã€æ¬Šå¨æ€§é©—è­‰åˆ°åˆ†ç´šå„²å­˜çš„å®Œæ•´æµç¨‹ï¼Œç¢ºä¿ã€Œåƒåœ¾é€²ï¼Œåƒåœ¾å‡ºã€çš„æƒ…æ³ä¸æœƒç™¼ç”Ÿï¼Œè®“ä¸Šå±¤æ¨¡çµ„èƒ½å°ˆæ³¨æ–¼é‚è¼¯èˆ‡æ¨è«–ã€‚\n\næ¨¡çµ„é‡é»ï¼š\nâ€¢ è³‡æ–™ä¾†æºå¯ä¿¡ï¼šåªæ”¶éŒ„é«˜å¯ä¿¡åº¦çš„ç¶²ç«™èˆ‡å…§å®¹ï¼Œä¸¦é€éæ¬Šå¨æ€§è©•åˆ†é€²è¡Œæ²»ç†ã€‚\nâ€¢ æª¢ç´¢æ•ˆèƒ½ç©©å®šï¼šæ•´åˆçµæ§‹åŒ–è³‡æ–™åº«ã€å‘é‡æœå°‹èˆ‡å¿«å–ï¼Œå¿«é€Ÿå–å›èˆ‡æŸ¥è©¢æ„åœ–æœ€æ¥è¿‘çš„æ–‡ä»¶ã€‚\nâ€¢ è‡ªå‹•åŒ–æƒ…å ±è’é›†ï¼šå…¨å¤©å€™ç›£æ§æŒ‡å®šçš„é«˜åƒ¹å€¼ä¾†æºï¼Œç¢ºä¿è³‡è¨Šæ™‚æ•ˆæ€§èˆ‡å®Œæ•´æ€§ã€‚",
      "script": "",
      "isModuleHeader": true,
      "x": 22,
      "y": 232,
      "workflows": [
        "workflow2",
        "workflow5"
      ]
    },
    {
      "id": "sys-db",
      "labelEn": "Postgres DB",
      "labelZh": "è³‡æ–™åº«",
      "moduleId": 6,
      "status": "done",
      "rationale": "ç›®çš„ï¼šå„²å­˜çµæ§‹åŒ– ML ç”¨è³‡æ–™ä½œç‚ºè³‡æ–™åŸºåº•ã€‚\næŠ€è¡“/åŠŸèƒ½å¯¦ç¾ï¼šä½¿ç”¨ç·šä¸Š PostgreSQLï¼Œå­˜æ”¾ document objectã€metadataï¼Œä»¥åŠä¾›æ¨¡å‹è¨“ç·´ä½¿ç”¨çš„æ¬„ä½ã€‚",
      "script": "retrieval_providers/postgres_client.py",
      "x": 1193,
      "y": 38,
      "workflows": [
        "workflow1",
        "workflow2",
        "workflow3",
        "workflow5"
      ],
      "isModuleHeader": false
    },
    {
      "id": "sys-cache",
      "labelEn": "In-Memory Cache",
      "labelZh": "è¨˜æ†¶é«”å¿«å–",
      "moduleId": 6,
      "status": "done",
      "rationale": "ç›®çš„ï¼šåŠ é€Ÿé‡è¤‡æŸ¥è©¢èˆ‡æª¢ç´¢æµç¨‹ï¼Œä¾›é€²ä¸€æ­¥åˆ†æèˆ‡æ¨è«–ä½¿ç”¨ã€‚\næŠ€è¡“/åŠŸèƒ½å¯¦ç¾ï¼šå¿«å– retrieval çµæœï¼Œæä¾›å¾ŒçºŒæ¨¡çµ„åˆ†æèˆ‡æ¨è«–ã€‚",
      "script": "chat/cache.py",
      "x": 2354,
      "y": 88,
      "workflows": [
        "workflow1",
        "workflow3",
        "workflow5"
      ]
    },
    {
      "id": "sys-vec",
      "labelEn": "Qdrant Vector DB",
      "labelZh": "å‘é‡è³‡æ–™åº«",
      "moduleId": 0,
      "status": "partial",
      "rationale": "ç›®çš„ï¼šæä¾›èªæ„æª¢ç´¢èƒ½åŠ›ï¼Œæ”¯æ´æ··åˆæª¢ç´¢ã€‚\næŠ€è¡“/åŠŸèƒ½å¯¦ç¾ï¼šå­˜å…¨æ–‡ + metadata + embeddingï¼Œä½œç‚ºæ··åˆç´¢å¼•æŸ¥è©¢åŸºåº•ã€‚",
      "script": "retrieval_providers/qdrant.py",
      "x": 593,
      "y": 884,
      "workflows": [
        "workflow1",
        "workflow2",
        "workflow3",
        "workflow5"
      ]
    },
    {
      "id": "sqlite-dev",
      "labelEn": "SQLite DB",
      "labelZh": "SQLiteé–‹ç™¼åº«",
      "moduleId": 6,
      "status": "done",
      "rationale": "ç›®çš„ï¼šæœ¬åœ°é–‹ç™¼èˆ‡ pipeline æ¨¡æ“¬ã€‚\næŠ€è¡“/åŠŸèƒ½å¯¦ç¾ï¼šä½¿ç”¨ SQLite å„²å­˜è‡¨æ™‚ ML è¨“ç·´è³‡æ–™ï¼Œæ¨¡æ“¬ç³»çµ±è¡Œç‚ºï¼Œä¸å­˜ä½¿ç”¨è€…è¡Œç‚ºè³‡æ–™ã€‚",
      "script": "storage/sqlite_dev.py",
      "x": 1195,
      "y": 137,
      "workflows": [
        "workflow5"
      ]
    },
    {
      "id": "data-chunking",
      "labelEn": "Data Chunking",
      "labelZh": "è³‡æ–™åˆ†ç´š",
      "moduleId": 0,
      "status": "notdone",
      "rationale": "ç›®çš„ï¼šä¾è³‡æ–™é‡è¦æ€§ä¸åŒè™•ç†ï¼Œå„ªåŒ–å„²å­˜èˆ‡æª¢ç´¢æ•ˆç‡ã€‚\næŠ€è¡“/åŠŸèƒ½å¯¦ç¾ï¼šå°é‡è¦æ–‡ä»¶é€²è¡Œç²¾ç´° chunkingï¼›å°ä¸€èˆ¬æ–‡ä»¶åªå­˜ metadata æˆ–å…¨æ–‡ï¼Œä¸å­˜ embeddingï¼›æ”¯æ´ minimal chunking ç­‰ä¸åŒé¡†ç²’åº¦å„²å­˜ç­–ç•¥ã€‚",
      "script": "indexing/chunking.py",
      "x": 312,
      "y": 1058,
      "workflows": [
        "workflow2",
        "workflow5"
      ]
    },
    {
      "id": "auto-crawler",
      "labelEn": "Auto Crawler",
      "labelZh": "è‡ªå‹•çˆ¬èŸ²",
      "moduleId": 0,
      "status": "notdone",
      "rationale": "ç›®çš„ï¼šè‡ªå‹•æŠ“å–ä¾†æºç¶²ç«™æ–‡ä»¶ï¼Œç¢ºä¿å„²å­˜è³‡æ–™å®Œæ•´ã€‚\næŠ€è¡“/åŠŸèƒ½å¯¦ç¾ï¼šè¦åŠƒå»ºç«‹çˆ¬èŸ² pipelineï¼Œè‡ªå‹•æŠ“å–é«˜å¯ä¿¡åº¦ä¾†æºçš„æ–‡ä»¶ï¼›æ”¯æ´æ¬„ä½æŠ½å–ã€metadata æ¨™è¨˜ã€ä»¥åŠå¾ŒçºŒå„²å­˜åˆ°Qdrantã€‚",
      "script": "indexing/crawler.py",
      "x": 302,
      "y": 492,
      "workflows": [
        "workflow2",
        "workflow5"
      ]
    },
    {
      "id": "format-detect",
      "labelEn": "Format Detector",
      "labelZh": "æ ¼å¼åµæ¸¬",
      "moduleId": 0,
      "status": "notdone",
      "rationale": "ç›®çš„ï¼šç¶­æŒè³‡æ–™æº–ç¢ºæ€§èˆ‡æœ€æ–°ç‹€æ…‹ã€‚\næŠ€è¡“/åŠŸèƒ½å¯¦ç¾ï¼šè¦åŠƒè‡ªå‹•åµæ¸¬ç¶²ç«™æ ¼å¼æˆ–æ–‡ç« ç‰ˆæœ¬è®Šå‹•ï¼Œæ›´æ–° Storage ä¸­çš„æ–‡ä»¶ï¼Œç¢ºä¿è³‡æ–™ä¸€è‡´æ€§ã€‚",
      "script": "indexing/format_detector.py",
      "x": 429,
      "y": 629,
      "workflows": [
        "workflow2",
        "workflow5"
      ]
    },
    {
      "id": "user-data",
      "labelEn": "User Data Storage",
      "labelZh": "ä½¿ç”¨è€…è³‡æ–™",
      "moduleId": 6,
      "status": "notdone",
      "rationale": "ç›®çš„ï¼šè¨˜éŒ„ä½¿ç”¨è€…ç›¸é—œè³‡æ–™ï¼Œç”¨æ–¼åˆ†æèˆ‡å€‹æ€§åŒ–æ¨è«–ã€‚\næŠ€è¡“/åŠŸèƒ½å¯¦ç¾ï¼šå„²å­˜ä½¿ç”¨è€…ç™»å…¥è³‡è¨Šã€éå¾€å°è©±æ­·å²ç­‰ï¼Œæ”¯æ´ç³»çµ±æä¾›ç¶²ç«™é«”é©—ã€‚",
      "script": "storage/user_data.py",
      "x": 1623,
      "y": 86,
      "workflows": [
        "workflow2",
        "workflow5"
      ]
    },
    {
      "id": "quality-gate",
      "labelEn": "Quality Gate",
      "labelZh": "å“è³ªé–˜é–€",
      "moduleId": 0,
      "status": "notdone",
      "rationale": "ç›®çš„ï¼šä½œç‚ºè³‡æ–™å“è³ªçš„å®ˆé–€å“¡ï¼Œé˜²æ­¢ã€Œåƒåœ¾é€²ã€åƒåœ¾å‡ºã€ã€‚\næŠ€è¡“/åŠŸèƒ½å¯¦ç¾ï¼šä¾æ“šå…§å®¹é•·åº¦ã€äº‚ç¢¼æ¯”ä¾‹ã€èªè¨€æ©Ÿç‡ç­‰æŒ‡æ¨™ï¼Œè‡ªå‹•å‰”é™¤ä½å“è³ªæˆ–ç„¡æ•ˆçš„ç¶²é å…§å®¹ã€‚",
      "script": "indexing/quality_gate.py",
      "x": 312,
      "y": 767,
      "workflows": [
        "workflow2",
        "workflow5"
      ]
    },
    {
      "id": "light-ner",
      "labelEn": "Light NER",
      "labelZh": "è¼•é‡NER",
      "moduleId": 0,
      "status": "notdone",
      "rationale": "ç›®çš„ï¼šè±å¯Œè³‡æ–™çš„ Metadataï¼Œæå‡æª¢ç´¢éæ¿¾çš„ç²¾æº–åº¦ã€‚\næŠ€è¡“/åŠŸèƒ½å¯¦ç¾ï¼šä½¿ç”¨è¼•é‡ç´šæ¨¡å‹å¿«é€Ÿè­˜åˆ¥æ–‡ç« ä¸­çš„äººåã€æ©Ÿæ§‹ã€åœ°åï¼Œä¸éœ€å‘¼å«æ˜‚è²´çš„LLMã€‚",
      "script": "indexing/light_ner.py",
      "x": 310,
      "y": 912,
      "workflows": [
        "workflow2",
        "workflow5"
      ]
    },
    {
      "id": "src-auth",
      "labelEn": "Source Authority",
      "labelZh": "ä¾†æºæ¬Šå¨",
      "moduleId": 0,
      "status": "notdone",
      "rationale": "ç›®çš„ï¼šå»ºç«‹è³‡æ–™ä¾†æºçš„æ¬Šå¨æ€§è©•ç´šï¼Œå„ªå…ˆå±•ç¤ºå¯ä¿¡å…§å®¹ã€‚\næŠ€è¡“/åŠŸèƒ½å¯¦ç¾ï¼šä¾æ“šåŸŸåæ­·å²ä¿¡è­½ã€å¼•ç”¨æ¬¡æ•¸ç­‰è¨ˆç®—æ¬Šå¨åˆ†æ•¸ï¼Œç›´æ¥å½±éŸ¿å¾ŒçºŒçš„æ’åºæ¬Šé‡ã€‚",
      "script": "indexing/source_authority.py",
      "x": 546,
      "y": 360,
      "workflows": [
        "workflow2",
        "workflow5"
      ]
    },
    {
      "id": "domain-allowlist",
      "labelEn": "Domain Allowlist",
      "labelZh": "åŸŸåç™½åå–®",
      "moduleId": 0,
      "status": "notdone",
      "rationale": "ç›®çš„ï¼šç¢ºä¿ç³»çµ±åƒ…æ”¶éŒ„åˆè¦èˆ‡é«˜å¯ä¿¡åº¦çš„ä¾†æºã€‚\næŠ€è¡“/åŠŸèƒ½å¯¦ç¾ï¼šç¶­è­·å‹•æ…‹çš„ç™½åå–®æ©Ÿåˆ¶ï¼Œéæ¸…å–®å…§çš„ä¾†æºå°‡è¢«æ¨™è¨˜æˆ–é˜»æ“‹ï¼Œæ”¯æ´ä¼æ¥­è‡ªè¨‚ä¿¡ä»»æ¸…å–®ã€‚",
      "script": "indexing/domain_allowlist.py",
      "x": 24,
      "y": 359,
      "workflows": [
        "workflow2",
        "workflow5"
      ]
    },
    {
      "id": "regex-parser",
      "labelEn": "Regex Parser",
      "labelZh": "è¦å‰‡è§£æå™¨",
      "moduleId": 0,
      "status": "notdone",
      "rationale": "ç›®çš„ï¼šé‡å°é«˜çµæ§‹åŒ–è³‡æ–™ï¼ˆå¦‚è²¡å ±ã€æ³•è¦ç·¨è™Ÿï¼‰é€²è¡Œç²¾ç¢ºæå–ã€‚\næŠ€è¡“/åŠŸèƒ½å¯¦ç¾ï¼šä½¿ç”¨è¦å‰‡è¡¨é”å¼å¼•æ“æå–ç‰¹å®šæ ¼å¼è³‡è¨Šï¼Œè¼”åŠ© LLM è™•ç†éè‡ªç„¶èªè¨€çš„æ•¸æ“šã€‚",
      "script": "indexing/regex_parser.py",
      "x": 187,
      "y": 629,
      "workflows": [
        "workflow2",
        "workflow5"
      ]
    },
    {
      "id": "anomaly-detector",
      "labelEn": "Anomaly Detector",
      "labelZh": "ç•°å¸¸åµæ¸¬",
      "moduleId": 0,
      "status": "notdone",
      "rationale": "ç›®çš„ï¼šç›£æ§è³‡æ–™æµçš„å¥åº·ç‹€æ³ï¼Œå³æ™‚ç™¼ç¾çˆ¬èŸ²æˆ–ä¾†æºç•°å¸¸ã€‚\næŠ€è¡“/åŠŸèƒ½å¯¦ç¾ï¼šåµæ¸¬ä¾†æºç¶²ç«™æ˜¯å¦å‡ºç¾å¤§é‡ 404ã€å…§å®¹ç©ºç™½æˆ–è³‡æ–™åˆ†ä½ˆåç§»ï¼Œç¢ºä¿ç´¢å¼•åº«å¥åº·ã€‚",
      "script": "indexing/anomaly_detector.py",
      "x": 299,
      "y": 365,
      "workflows": [
        "workflow2",
        "workflow5"
      ]
    },
    {
      "id": "mod-input",
      "labelEn": "Input",
      "labelZh": "å…¥å£èˆ‡å®‰å…¨",
      "moduleId": 1,
      "status": "header",
      "rationale": "Input æ¨¡çµ„æ˜¯ä¼æ¥­èˆ‡ä½¿ç”¨è€…æ¥å…¥ç³»çµ±çš„å®‰å…¨é–˜é“ã€‚å®ƒä¸åƒ…æ˜¯æ¥æ”¶æŒ‡ä»¤çš„çª—å£ï¼Œæ›´æ˜¯ç†è§£ä½¿ç”¨è€…æ„åœ–èˆ‡é˜²ç¯„æƒ¡æ„æ”»æ“Šçš„ç¬¬ä¸€é“é˜²ç·šï¼Œç¢ºä¿å¾ŒçºŒçš„é«˜ç®—åŠ›æ¨¡çµ„åƒ…è™•ç†å®‰å…¨ã€æ¸…æ™°ä¸”çµæ§‹åŒ–çš„è«‹æ±‚ã€‚\n\næ¨¡çµ„é‡é»ï¼š\nâ€¢ ä¼æ¥­ç´šå®‰å…¨æ€§ï¼šåœ¨ LLM æ¥è§¸è³‡æ–™å‰å³æ””æˆªæƒ¡æ„æŒ‡ä»¤ (Prompt Injection)ï¼Œä¿éšœç³»çµ±åˆè¦èˆ‡éš±ç§ã€‚\nâ€¢ å¤šæ¨¡æ…‹è³‡æ–™æ•´åˆï¼šæ”¯æ´ä¼æ¥­ä¸Šå‚³ç§æœ‰æ–‡ä»¶ï¼ˆPDF/Wordï¼‰ï¼Œå¯¦ç¾ã€Œå¸¶å…¥è‡ªæœ‰è³‡æ–™ (BYOD)ã€çš„å°ˆå±¬åˆ†æèƒ½åŠ›ã€‚\nâ€¢ ç²¾æº–æ„åœ–è­˜åˆ¥ï¼šå°‡è¤‡é›œçš„å•†æ¥­å•é¡Œæ‹†è§£ç‚ºå¯åŸ·è¡Œçš„æª¢ç´¢æ­¥é©Ÿï¼Œæå‡å›ç­”ç²¾æº–åº¦ã€‚",
      "script": "",
      "isModuleHeader": true,
      "x": 1100,
      "y": 280,
      "workflows": [
        "workflow1",
        "workflow3",
        "workflow4",
        "workflow5"
      ]
    },
    {
      "id": "prompt-guardrails",
      "labelEn": "Prompt Guardrails",
      "labelZh": "æç¤ºé˜²è­·",
      "moduleId": 1,
      "status": "notdone",
      "rationale": "ç›®çš„ï¼šä¿éšœä¼æ¥­è³‡å®‰ï¼Œé˜²æ­¢æƒ¡æ„ä½¿ç”¨è€…é€éæŒ‡ä»¤è¶Šç„æˆ–ç«Šå–ç³»çµ±æ©Ÿå¯†ã€‚\næŠ€è¡“/åŠŸèƒ½å¯¦ç¾ï¼šå»ºç«‹æƒ¡æ„ç‰¹å¾µåº«èˆ‡å°æŠ—æ€§æª¢æ¸¬å±¤ï¼Œåœ¨æŸ¥è©¢é€²å…¥æ ¸å¿ƒç³»çµ±å‰å³æ™‚æ””æˆªä¸¦éæ¿¾æ½›åœ¨æ”»æ“Šã€‚",
      "script": "core/prompt_guardrails.py",
      "x": 968,
      "y": 388,
      "workflows": [
        "workflow2",
        "workflow5"
      ]
    },
    {
      "id": "upload-gateway",
      "labelEn": "Upload Gateway",
      "labelZh": "ä¸Šå‚³é–˜é“",
      "moduleId": 1,
      "status": "notdone",
      "rationale": "ç›®çš„ï¼šè®“ä¼æ¥­èƒ½å°‡å…§éƒ¨å ±å‘Šã€è²¡å ±æˆ–æ–‡ç»å°å…¥ç³»çµ±ï¼Œé€²è¡Œå°ˆå±¬çŸ¥è­˜åº«çš„åˆ†æã€‚\næŠ€è¡“/åŠŸèƒ½å¯¦ç¾ï¼šæ•´åˆ OCR èˆ‡ ETL æµç¨‹ï¼Œæ”¯æ´ PDF/Word/URL ç­‰æ ¼å¼ï¼Œè‡ªå‹•é€²è¡Œç—…æ¯’æƒæã€æ¸…æ´—èˆ‡æ–‡å­—æå–ã€‚",
      "script": "input/upload_gateway.py",
      "x": 974,
      "y": 524,
      "workflows": [
        "workflow5"
      ]
    },
    {
      "id": "query-decomp",
      "labelEn": "Query Decomposition",
      "labelZh": "æŸ¥è©¢æ‹†è§£",
      "moduleId": 1,
      "status": "done",
      "rationale": "ç›®çš„ï¼šè§£æ±ºã€Œæ¯”è¼ƒå‹ã€æˆ–ã€Œå¤šå±¤æ¬¡ã€çš„è¤‡é›œå•†æ¥­å•é¡Œï¼ˆå¦‚ï¼šæ¯”è¼ƒ A èˆ‡ B å…¬å¸çš„ Q3 è²¡å ±ï¼‰ã€‚\næŠ€è¡“/åŠŸèƒ½å¯¦ç¾ï¼šä½¿ç”¨ LLM å°‡ä¸€å€‹å¤§å•é¡Œæ‹†è§£ç‚ºå¤šå€‹ç¨ç«‹çš„å­æŸ¥è©¢æ„åœ–ï¼Œç¢ºä¿æª¢ç´¢æ¨¡çµ„èƒ½ç²¾æº–èª¿é–±ä¸åŒé¢å‘çš„è³‡æ–™ã€‚",
      "script": "chat/chatbot_interface.py",
      "x": 1190,
      "y": 467,
      "workflows": [
        "workflow1",
        "workflow3",
        "workflow4",
        "workflow5"
      ]
    },
    {
      "id": "mod-retrieval",
      "labelEn": "Retrieval",
      "labelZh": "æª¢ç´¢",
      "moduleId": 2,
      "status": "header",
      "rationale": "Retrieval æ¨¡çµ„è² è²¬æ ¹æ“šä½¿ç”¨è€…æŸ¥è©¢ï¼Œå¾ Storage (Indexing) æˆ–ç¶²è·¯æ‰¾åˆ°ç›¸é—œè³‡æ–™ï¼Œæä¾›çµ¦å¾ŒçºŒæ¨¡çµ„é€²è¡Œæ’åºèˆ‡æ¨è«–ã€‚\n\næ¨¡çµ„é‡é»ï¼š\nâ€¢ å·²å¯¦ä½œéƒ¨åˆ†ï¼šInternal Indexï¼Œè² è²¬å°‡ Storage è£¡çš„è³‡æ–™è½‰æ›ç‚ºå¯æŸ¥è©¢å½¢å¼ï¼Œä¾›ä¸Šå±¤æ¨¡çµ„ä½¿ç”¨ã€‚\nâ€¢ è¦åŠƒä¸­ï¼šWeb Search åŠŸèƒ½å°šæœªå¯¦ä½œï¼Œæœªä¾†å°‡æ”¯æ´å¾å¤–éƒ¨ç¶²è·¯æŠ“å–è³‡æ–™ï¼›æ”¯æ´å¤šå€‹è³‡æ–™ä¾†æºï¼ŒåŒ…å«ä¼æ¥­è‡ªè¨‚è³‡æ–™èˆ‡å¤–éƒ¨ç¶²è·¯ï¼Œä½œç‚ºæ··åˆæª¢ç´¢ç­–ç•¥çš„ä¸€éƒ¨åˆ†ã€‚\nâ€¢ æ¨¡çµ„åƒ¹å€¼ï¼šä½œç‚ºè³‡æ–™æœå°‹å¼•æ“ï¼Œæœå‹™ä¸Šå±¤çš„ Ranking èˆ‡ Reasoning æ¨¡çµ„ï¼Œç¢ºä¿å¾ŒçºŒæµç¨‹èƒ½å–å¾—ç›¸é—œè³‡è¨Šã€‚\nâ€¢ æ ¸å¿ƒç‰¹é»ï¼šæ”¯æ´å¤šä¾†æºæœå°‹ï¼ŒåŒ…æ‹¬ Storageã€å¤–éƒ¨ Web API ä»¥åŠä¼æ¥­è‡ªè¨‚è³‡æ–™ï¼›å¯çµåˆä¸åŒç´¢å¼•ç­–ç•¥ï¼ˆInternal Index / Qdrant / Web Searchï¼‰æä¾›å½ˆæ€§å¬å›ã€‚",
      "script": "",
      "isModuleHeader": true,
      "x": 997,
      "y": 954,
      "workflows": [
        "workflow1",
        "workflow3",
        "workflow4",
        "workflow5"
      ]
    },
    {
      "id": "internal-index",
      "labelEn": "Internal Search",
      "labelZh": "å…§éƒ¨ç´¢å¼•",
      "moduleId": 2,
      "status": "partial",
      "rationale": "ç›®çš„ï¼šæä¾›ç³»çµ±å…§éƒ¨è³‡æ–™çš„æª¢ç´¢èƒ½åŠ›ï¼Œæ”¯æ´å¾ŒçºŒæ’åºèˆ‡æ¨è«–ã€‚\næŠ€è¡“/åŠŸèƒ½å¯¦ç¾ï¼šåˆ©ç”¨BM25é—œéµå­—æœå°‹æ¼”ç®—æ³•åŠLLMèªæ„æœå°‹ï¼Œå¯¦ç¾æ··åˆå¼æª¢ç´¢ã€‚",
      "script": "core/retriever.py",
      "x": 946,
      "y": 759,
      "workflows": [
        "workflow1",
        "workflow3",
        "workflow4",
        "workflow5"
      ]
    },
    {
      "id": "web-search",
      "labelEn": "Web Search",
      "labelZh": "ç¶²è·¯æœå°‹",
      "moduleId": 2,
      "status": "notdone",
      "rationale": "ç›®çš„ï¼šè£œå……å³æ™‚è³‡è¨Šï¼Œæ”¯æ´ç³»çµ±ç²å– Storage å¤–è³‡æ–™ã€‚\næŠ€è¡“/åŠŸèƒ½å¯¦ç¾ï¼šæŠ“å–ç¶²è·¯è³‡æ–™å¾Œå­˜å…¥ cacheï¼Œä¾›å¾ŒçºŒåˆ†æèˆ‡æ¨è«–ä½¿ç”¨ã€‚",
      "script": "core/web_search.py",
      "x": 1395,
      "y": 769,
      "workflows": [
        "workflow3",
        "workflow4",
        "workflow5"
      ]
    },
    {
      "id": "multi-source",
      "labelEn": "Custom Source Search",
      "labelZh": "å¤šæºæœå°‹",
      "moduleId": 2,
      "status": "notdone",
      "rationale": "ç›®çš„ï¼šæœå°‹ç”¨æˆ¶è‡ªè¡Œä¸Šå‚³æˆ–é€£çµçš„å…§å®¹\næŠ€è¡“/åŠŸèƒ½å¯¦ç¾ï¼šæœå°‹ä¼æ¥­è‡ªè¨‚è³‡æ–™ï¼Œçµåˆå…§éƒ¨æœå°‹åŠç¶²è·¯æœå°‹ï¼Œå¯¦ç¾æ··åˆæœå°‹ç­–ç•¥ã€‚",
      "script": "retrieval/custom_source.py",
      "x": 1169,
      "y": 763,
      "workflows": [
        "workflow3",
        "workflow5"
      ]
    },
    {
      "id": "mod-ranking",
      "labelEn": "Ranking",
      "labelZh": "æ’åº",
      "moduleId": 3,
      "status": "header",
      "rationale": "Ranking æ¨¡çµ„è² è²¬å° Retrieval å›å‚³çš„è³‡æ–™é€²è¡Œæ’åºèˆ‡ç‰¹å¾µè¨ˆç®—ï¼Œé¸å‡ºé©åˆ Reasoning æ¨¡çµ„ä½¿ç”¨çš„ top resultsã€‚\n\næ¨¡çµ„é‡é»ï¼š\nâ€¢ å·²å¯¦ä½œéƒ¨åˆ†ï¼šè¦å‰‡å¼ä¾ query é¡å‹èª¿æ•´æ¬Šé‡ï¼Œç¢ºä¿ä¸åŒæŸ¥è©¢é¡å‹å¾—åˆ°é©åˆçš„æ’åºç­–ç•¥ï¼›XGBoost æ¼”ç®—æ³•ï¼Œç”¨æ–¼çµåˆå¤šç¨®æ’åºç‰¹å¾µï¼ˆå¦‚å‘é‡ç›¸ä¼¼åº¦ã€metadataã€è¦å‰‡æ¬Šé‡ï¼‰åšç¶œåˆè©•åˆ†ï¼Œæå‡çµæœå“è³ªï¼›MMRï¼ˆMaximal Marginal Relevanceï¼‰ï¼Œç”¨ä¾†å¹³è¡¡å¤šå…ƒæ€§èˆ‡ç›¸é—œæ€§ï¼Œç¢ºä¿æ’åºçµæœå¤šæ¨£æ€§ã€‚\nâ€¢ è¦åŠƒä¸­ï¼šåˆ©ç”¨ LLM é€²è¡Œå‹•æ…‹æ¬Šé‡èª¿æ•´ï¼Œæœªä¾†å¯æ ¹æ“š query é¡å‹å½ˆæ€§èª¿æ•´å„æ’åºç‰¹å¾µçš„å½±éŸ¿åŠ›ï¼Œæé«˜å°å¤šæ¨£åŒ–æŸ¥è©¢çš„é©æ‡‰èƒ½åŠ›ã€‚\nâ€¢ æ¨¡çµ„åƒ¹å€¼/æ ¸å¿ƒç‰¹é»ï¼šRanking æ¨¡çµ„çš„å­˜åœ¨æ˜¯ç‚ºäº†ç¢ºä¿ Reasoning æ¨¡çµ„æ¥æ”¶åˆ°æœ€é©åˆçš„ top resultsï¼Œå…¼é¡§çµæœçš„å¤šå…ƒæ€§èˆ‡ç²¾ç¢ºæ€§ã€‚é€éå¤šç¨®æ¼”ç®—æ³•èˆ‡ç‰¹å¾µçµåˆï¼ŒRanking å¯æ ¹æ“šæŸ¥è©¢ç‰¹æ€§èª¿æ•´æ’åºç­–ç•¥ï¼Œæ”¯æ´ç³»çµ±å°ä¸åŒæŸ¥è©¢çš„éœ€æ±‚ã€‚",
      "script": "",
      "isModuleHeader": true,
      "x": 1834,
      "y": 353,
      "workflows": [
        "workflow1",
        "workflow3",
        "workflow5"
      ]
    },
    {
      "id": "mmr",
      "labelEn": "MMR",
      "labelZh": "MMRå¤šæ¨£æ€§",
      "moduleId": 3,
      "status": "done",
      "rationale": "ç›®çš„ï¼šæ ¹æ“šæœå°‹èˆ‡æ¨è«–æ€§è³ªæ±ºå®šæ’åºï¼Œå¹³è¡¡å¤šå…ƒè§€é»èˆ‡ç²¾æº–è³‡è¨Šã€‚\næŠ€è¡“/åŠŸèƒ½å¯¦ç¾ï¼šä½¿ç”¨ MMR æ¼”ç®—æ³•åœ¨å›å‚³çµæœä¸­é¸æ“‡ top resultsï¼Œå…¼é¡§å¤šæ¨£æ€§èˆ‡ç›¸é—œæ€§ã€‚",
      "script": "core/mmr.py",
      "x": 1835,
      "y": 985,
      "workflows": [
        "workflow1",
        "workflow3",
        "workflow5"
      ]
    },
    {
      "id": "xgboost",
      "labelEn": "XGBoost Ranking",
      "labelZh": "XGBoostæ’åº",
      "moduleId": 3,
      "status": "done",
      "rationale": "ç›®çš„ï¼šå°‡å¤šç¨®æ’åºç‰¹å¾µç¶œåˆè©•åˆ†ï¼Œæå‡æ’åºç²¾æº–åº¦ã€‚\næŠ€è¡“/åŠŸèƒ½å¯¦ç¾ï¼šä½¿ç”¨ XGBoost æ¼”ç®—æ³•çµåˆæ•¸åç¨®ç‰¹å¾µï¼ˆåŒ…æ‹¬ embeddingã€metadataã€è¦å‰‡æ¬Šé‡ç­‰ï¼‰è¨ˆç®—æ¯å€‹çµæœçš„æ’åºåˆ†æ•¸ã€‚",
      "script": "core/xgboost_ranker.py",
      "x": 1835,
      "y": 827,
      "workflows": [
        "workflow1",
        "workflow3",
        "workflow5"
      ]
    },
    {
      "id": "rule-weight",
      "labelEn": "Rule Weight",
      "labelZh": "è¦å‰‡æ¬Šé‡",
      "moduleId": 3,
      "status": "done",
      "rationale": "ç›®çš„ï¼šä¾ query é¡å‹èª¿æ•´ä¸åŒæ’åºç‰¹å¾µçš„å½±éŸ¿åŠ›ã€‚\næŠ€è¡“/åŠŸèƒ½å¯¦ç¾ï¼šæ¡è¦å‰‡å¼ç­–ç•¥ï¼Œæ ¹æ“šæŸ¥è©¢æ€§è³ªèª¿æ•´ XGBoost ç­‰ç‰¹å¾µçš„æ¬Šé‡ï¼Œä¿è­‰æ’åºçµæœç¬¦åˆæŸ¥è©¢éœ€æ±‚ã€‚",
      "script": "ranking/rule_weight.py",
      "x": 1835,
      "y": 667,
      "workflows": [
        "workflow1",
        "workflow3",
        "workflow5"
      ]
    },
    {
      "id": "llm-weight",
      "labelEn": "LLM Weight",
      "labelZh": "LLMæ¬Šé‡",
      "moduleId": 3,
      "status": "notdone",
      "rationale": "ç›®çš„ï¼šæœªä¾†å¯åˆ©ç”¨èªæ„åˆ†æè‡ªå‹•èª¿æ•´æ’åºæ¬Šé‡ï¼Œé€²ä¸€æ­¥ç¬¦åˆä½¿ç”¨è€…éœ€æ±‚ã€‚\næŠ€è¡“/åŠŸèƒ½å¯¦ç¾ï¼šè¨ˆç•«ä½¿ç”¨ LLM åˆ†æ query èªæ„ï¼Œèª¿æ•´å„ç‰¹å¾µæ¬Šé‡ï¼›ç³»çµ±ç”šè‡³å¯èˆ‡ä½¿ç”¨è€…äº’å‹•ï¼Œè¨è«–ä¸¦å„ªåŒ–æœå°‹çµæœã€‚",
      "script": "ranking/llm_weight.py",
      "x": 1835,
      "y": 476,
      "workflows": [
        "workflow3",
        "workflow5"
      ]
    },
    {
      "id": "mod-reasoning",
      "labelEn": "Reasoning",
      "labelZh": "æ¨è«–",
      "moduleId": 4,
      "status": "header",
      "rationale": "Reasoning æ¨¡çµ„è² è²¬å° Retrieval + Ranking å›å‚³çš„è³‡æ–™é€²è¡Œåˆ†æã€æ•´åˆèˆ‡æ¨è«–ï¼Œç”Ÿæˆå¯é ã€å¯ç”¨çš„çµè«–æˆ–æ´å¯Ÿã€‚é€™æ˜¯æœ¬ç”¢å“æœ€é—œéµçš„ç‰¹è‰²ï¼Œä¹Ÿæ˜¯è² è²¬æŒ‡æ® retrieval å’Œ ranking çš„å¤§è…¦ï¼\n\næ¨¡çµ„é‡é»ï¼š\nâ€¢ å·²å¯¦ä½œéƒ¨åˆ†ï¼šåŸºæœ¬æ ¼å¼é™å®šèˆ‡ prompt è¨­è¨ˆï¼Œæ¨è«–äº‹å¯¦ä»¥ cached documents ç‚ºä¾æ“šã€‚\nâ€¢ è¦åŠƒä¸­ï¼šEvidence chain å»ºæ§‹ï¼ˆè¿½è¹¤æ¨è«–ä¾†æºèˆ‡æ­¥é©Ÿï¼‰ï¼›Knowledge boundary èˆ‡ gap detectionï¼ˆæª¢æ¸¬è³‡æ–™è¦†è“‹ç¯„åœèˆ‡ç¼ºå£ï¼‰ï¼›Iterative / recursive searchï¼ˆå¤šæ¬¡æœå°‹å®Œå–„æ¨è«–çµæœï¼‰ï¼›Domain classifierï¼ˆä¾é ˜åŸŸåˆ¤æ–·è³‡æ–™èˆ‡æ¨è«–é©ç”¨æ€§ï¼‰ï¼›Logic verificationã€logic/source transparencyï¼ˆæª¢æŸ¥æ¨è«–é‚è¼¯åŠè³‡æ–™å¼•ç”¨é€æ˜åº¦ï¼‰ï¼›Knowledge graph generationï¼ˆå«ç·¨è¼¯åŠŸèƒ½ï¼Œè¼”åŠ©ä½¿ç”¨è€…æ¢ç´¢èˆ‡ç ”ç©¶ï¼‰ã€‚\nâ€¢ æ¨¡çµ„åƒ¹å€¼/æ ¸å¿ƒç‰¹é»ï¼šæå‡æ¨è«–å¯é æ€§ï¼Œç¢ºä¿è³‡æ–™ä¾†æºå¯ä¿¡ã€æ¨è«–å‘¨å…¨ã€é‚è¼¯èˆ‡å¼•ç”¨æª¢æŸ¥å®Œæ•´ï¼›å¤šæ¬¡æœå°‹ä¸å—é™æ–¼ä½¿ç”¨è€…åˆå§‹ queryï¼Œå®Œå–„æ¨è«–çµæœï¼›æä¾› knowledge graph ç­‰å·¥å…·ï¼Œå”åŠ©ä½¿ç”¨è€…æ¢ç´¢ã€ç ”ç©¶èˆ‡åˆ†æè³‡æ–™ã€‚",
      "script": "",
      "isModuleHeader": true,
      "x": 2342,
      "y": 360,
      "workflows": [
        "workflow1",
        "workflow3",
        "workflow4",
        "workflow5"
      ]
    },
    {
      "id": "orchestrator",
      "labelEn": "Deep Research Orchestrator",
      "labelZh": "ç¸½æ§èˆ‡æµç¨‹ç®¡ç†å™¨",
      "moduleId": 4,
      "status": "notdone",
      "rationale": "æ ¸å¿ƒå¤§è…¦ (State Machine)ã€‚\n1. ç®¡ç† Actor-Critic å¾ªç’°ã€‚\n2. æ•æ‰ Analyst çš„ 'SEARCH_REQUIRED' è«‹æ±‚ï¼ŒåŸ·è¡Œè£œå……æœå°‹ã€‚\n3. å‹•æ…‹æ³¨å…¥æ–°è³‡æ–™è‡³ Context ä¸¦é‡å•Ÿåˆ†ææµç¨‹ (Iterative Loop)ã€‚",
      "script": "reasoning/orchestrator.py",
      "x": 2199,
      "y": 483,
      "workflows": [
        "workflow1",
        "workflow3",
        "workflow4",
        "workflow5"
      ],
      "isModuleHeader": false
    },
    {
      "id": "clarification-agent",
      "labelEn": "Clarification Agent",
      "labelZh": "æ„åœ–æ¾„æ¸… Agent",
      "moduleId": 4,
      "status": "notdone",
      "rationale": "å‰ç½®è™•ç†å±¤ã€‚\nåŠŸèƒ½ï¼šè§£ææ™‚é–“èˆ‡å¯¦é«”æ­§ç¾© (Level 3 Parsing)ã€‚\næ•´åˆé»ï¼šç•¶ Orchestrator åˆ¤æ–·æ„åœ–ä¸æ¸…æ™‚å„ªå…ˆèª¿ç”¨ï¼Œç”¢å‡º JSON é¸é …ä¾›å‰ç«¯äº’å‹•ã€‚",
      "script": "reasoning/agents/clarification.py",
      "x": 2494,
      "y": 520,
      "workflows": [
        "workflow1",
        "workflow3",
        "workflow4",
        "workflow5"
      ],
      "isModuleHeader": false
    },
    {
      "id": "analyst-agent",
      "labelEn": "Analyst Agent",
      "labelZh": "åˆ†æå¸« Agent",
      "moduleId": 4,
      "status": "notdone",
      "rationale": "æ ¸å¿ƒæ¨è«–å¼•æ“ã€‚\n1. å»ºæ§‹å¿ƒæ™ºçŸ¥è­˜åœ–è­œä»¥æ¢³ç†å¯¦é«”é—œä¿‚ã€‚\n2. åŸ·è¡Œç¼ºå£åµæ¸¬ (Gap Detection)ï¼Œç¢ºèªç›®å‰æœåˆ°çš„è³‡è¨Šæ˜¯å¦å……åˆ†ã€‚\n3. è‹¥è­‰æ“šéˆæ–·è£‚ï¼Œè¼¸å‡º 'SEARCH_REQUIRED' JSON ç™¼èµ·æ–°æœå°‹ï¼›è‹¥å®Œæ•´ï¼Œæ‰æ’°å¯«è‰ç¨¿ã€‚\n4. è² è²¬æ¨è«–èˆ‡æœå°‹çš„å‘¨å…¨åº¦ã€‚",
      "script": "reasoning/agents/analyst.py",
      "x": 2199,
      "y": 681,
      "workflows": [
        "workflow1",
        "workflow3",
        "workflow4",
        "workflow5"
      ],
      "isModuleHeader": false
    },
    {
      "id": "kg-logic",
      "labelEn": "KG & Gap Detection",
      "labelZh": "åœ–è­œèˆ‡ç¼ºå£åµæ¸¬é‚è¼¯",
      "moduleId": 4,
      "status": "notdone",
      "rationale": "Analyst å…§éƒ¨çš„é—œéµæ€è€ƒæ­¥é©Ÿ (Thinking Process)ã€‚\nåŠŸèƒ½ï¼š\n1. æª¢æŸ¥æ¯å€‹æ¨è«–ç¯€é»æ˜¯å¦æœ‰ Tier 1-2 è­‰æ“šæ”¯æŒã€‚\n2. è­˜åˆ¥ã€Œå­¤ç«‹ç¯€é»ã€æˆ–ã€Œæ–·è£‚éˆæ¢ã€ã€‚\n3. å°‡æ¨¡ç³Šå•é¡Œè½‰åŒ–ç‚ºå…·é«”çš„ Search Queriesã€‚",
      "script": "reasoning/logic/kg_builder.py",
      "x": 2486,
      "y": 677,
      "workflows": [
        "workflow1",
        "workflow3",
        "workflow5"
      ],
      "isModuleHeader": false
    },
    {
      "id": "critic-agent",
      "labelEn": "Critic Agent",
      "labelZh": "è©•è«–å®¶ Agent",
      "moduleId": 4,
      "status": "notdone",
      "rationale": "å“è³ªå®ˆé–€å“¡ã€‚\nä»»å‹™ï¼š\n1. ä¾†æºåˆè¦æ€§æª¢æŸ¥ (Strict/Discovery Mode)ã€‚\n2. é‚è¼¯è¬¬èª¤æª¢æ¸¬ (æ­¸ç´/æ¼”ç¹¹/æº¯å› )ã€‚\n3. æª¢æŸ¥Monitor Mode çš„è¼¿æƒ…è½å·®åˆ†ææ˜¯å¦åˆç†ã€‚\n4. è² è²¬æŠŠé—œé‚è¼¯åš´è¬¹æ€§ã€‚",
      "script": "reasoning/agents/critic.py",
      "x": 2199,
      "y": 848,
      "workflows": [
        "workflow1",
        "workflow3",
        "workflow4",
        "workflow5"
      ],
      "isModuleHeader": false
    },
    {
      "id": "gap-analysis",
      "labelEn": "Gap Analysis Logic",
      "labelZh": "è½å·®åˆ†æé‚è¼¯ (Monitor)",
      "moduleId": 4,
      "status": "notdone",
      "rationale": "Monitor Mode å°ˆç”¨æ¨¡çµ„ã€‚\nåŠŸèƒ½ï¼šæ¯”å°ã€Œå®˜æ–¹æ•¸æ“šã€èˆ‡ã€Œç¤¾ç¾¤æ„ŸçŸ¥ã€åœ¨æ™‚é–“ã€æ…‹åº¦ã€æ­¸å› ä¸Šçš„è½å·®ï¼Œè¨ˆç®—é¢¨éšªç­‰ç´š (High/Medium/Low)ã€‚",
      "script": "reasoning/logic/gap_analysis.py",
      "x": 2493,
      "y": 817,
      "workflows": [
        "workflow1",
        "workflow3",
        "workflow5"
      ],
      "isModuleHeader": false
    },
    {
      "id": "writer-agent",
      "labelEn": "Writer Agent",
      "labelZh": "ç·¨è¼¯ Agent",
      "moduleId": 4,
      "status": "notdone",
      "rationale": "æœ€çµ‚è¼¸å‡ºå±¤ã€‚\nåŠŸèƒ½ï¼šæ¥æ”¶é€šé Critic å¯©æŸ¥çš„è‰ç¨¿ï¼Œé€²è¡Œæ ¼å¼åŒ–è¼¸å‡ºã€‚\næœƒæ˜ç¢ºæ¨™ç¤ºå‡ºæ¨è«–éç¨‹ï¼Œä»¥é›†å…¶ä¸­å¯èƒ½ä¸åš´è¬¹æˆ–è­‰æ“šä¸å……åˆ†ä¹‹è™•ã€‚",
      "script": "reasoning/agents/writer.py",
      "x": 2199,
      "y": 1002,
      "workflows": [
        "workflow1",
        "workflow3",
        "workflow4",
        "workflow5"
      ],
      "isModuleHeader": false
    },
    {
      "id": "mod-output",
      "labelEn": "Output",
      "labelZh": "è¼¸å‡ºèˆ‡ä»‹é¢",
      "moduleId": 5,
      "status": "header",
      "rationale": "Output æ¨¡çµ„æ˜¯å°‡è¤‡é›œçš„æ¨è«–çµæœè½‰åŒ–ç‚ºå•†æ¥­åƒ¹å€¼çš„é—œéµä»‹é¢ã€‚å®ƒä¸åƒ…æä¾›è¦–è¦ºåŒ–çš„åˆ†æå·¥å…·ï¼Œæ›´è³¦èƒ½åª’é«”å¤¥ä¼´èˆ‡ä¼æ¥­å®¢æˆ¶ï¼Œé€éæ•¸æ“šå„€è¡¨æ¿èˆ‡å”ä½œç®¡ç†åŠŸèƒ½ï¼Œå°‡ AI æ´å¯Ÿè½å¯¦åˆ°æ±ºç­–æµç¨‹ä¸­ã€‚\n\næ¨¡çµ„é‡é»ï¼š\nâ€¢ æ¨è«–å¯è¦–åŒ–ï¼šå°‡é»‘ç›’å­çš„æ¨è«–éç¨‹è½‰ç‚ºå¯äº’å‹•çš„çŸ¥è­˜åœ–è­œèˆ‡å¿ƒæ™ºåœ–ï¼Œè¼”åŠ©ç ”ç©¶äººå“¡æ¢ç´¢ã€‚\nâ€¢ åª’é«”è³¦èƒ½ï¼šæä¾›å°ˆå±¬å„€è¡¨æ¿ï¼Œè®“åª’é«”å¤¥ä¼´æŒæ¡è®€è€…é—œæ³¨çš„ç†±é»è­°é¡Œèˆ‡å°æµæˆæ•ˆã€‚\nâ€¢ å”ä½œèˆ‡ç®¡ç†ï¼šæ”¯æ´åœ˜éšŠå”ä½œã€è³‡æ–™ä¾†æºç®¡ç†èˆ‡å¤šæ ¼å¼åŒ¯å‡ºï¼Œç„¡ç¸«æ•´åˆè‡³å·¥ä½œæµã€‚",
      "script": "",
      "isModuleHeader": true,
      "x": 2872,
      "y": 353,
      "workflows": [
        "workflow1",
        "workflow3",
        "workflow4",
        "workflow5"
      ]
    },
    {
      "id": "sys-api",
      "labelEn": "API Gateway",
      "labelZh": "APIé–˜é“",
      "moduleId": 5,
      "status": "done",
      "rationale": "ç›®çš„ï¼šä½œç‚ºç³»çµ±èˆ‡ç¬¬ä¸‰æ–¹æœå‹™çš„æ¨™æº–åŒ–æ©‹æ¨‘ï¼Œæ”¯æ´å½ˆæ€§æ“´å……ã€‚\næŠ€è¡“/åŠŸèƒ½å¯¦ç¾ï¼šåŸºæ–¼ FastAPI çš„é«˜æ•ˆèƒ½è·¯ç”±æ ¸å¿ƒï¼Œè™•ç†èº«åˆ†é©—è­‰ã€æµé‡æ§åˆ¶èˆ‡ API è«‹æ±‚æ´¾ç™¼ã€‚",
      "script": "webserver/main.py",
      "x": 3118,
      "y": 354,
      "workflows": [
        "workflow1",
        "workflow3",
        "workflow5"
      ]
    },
    {
      "id": "sys-fe",
      "labelEn": "Frontend UI",
      "labelZh": "å‰ç«¯ä»‹é¢",
      "moduleId": 5,
      "status": "partial",
      "rationale": "ç›®çš„ï¼šæä¾›ç›´è¦ºçš„æ“ä½œé«”é©—ï¼Œè®“éæŠ€è¡“äººå“¡ä¹Ÿèƒ½è¼•é¬†ä½¿ç”¨ AI æ¨è«–ã€‚\næŠ€è¡“/åŠŸèƒ½å¯¦ç¾ï¼šæ•´åˆå°è©±ã€å¼•ç”¨é è¦½èˆ‡æ¨¡å¼åˆ‡æ›çš„ç¶œåˆä»‹é¢ï¼Œæ”¯æ´éŸ¿æ‡‰å¼è¨­è¨ˆã€‚",
      "script": "static/news-search-prototype.html",
      "x": 3025,
      "y": 485,
      "workflows": [
        "workflow1",
        "workflow3",
        "workflow4",
        "workflow5"
      ]
    },
    {
      "id": "llm-safety-net",
      "labelEn": "LLM Safety Net",
      "labelZh": "LLMå®‰å…¨ç¶²",
      "moduleId": 5,
      "status": "notdone",
      "rationale": "ç›®çš„ï¼šç¢ºä¿è¼¸å‡ºçš„åˆè¦æ€§èˆ‡å®‰å…¨æ€§ï¼Œä¿è­·å“ç‰Œè²è­½ã€‚\næŠ€è¡“/åŠŸèƒ½å¯¦ç¾ï¼šä½œç‚ºè¼¸å‡ºçš„æœ€å¾Œä¸€é“é–˜é–€ï¼Œè‡ªå‹•æª¢æ¸¬ä¸¦éæ¿¾ PII (å€‹è³‡)ã€æœ‰å®³å…§å®¹æˆ–ä¸ç•¶å»ºè­°ã€‚",
      "script": "output/llm_safety_net.py",
      "x": 3258,
      "y": 485,
      "workflows": [
        "workflow5"
      ]
    },
    {
      "id": "visualizer-engine",
      "labelEn": "Visualizer Engine",
      "labelZh": "è¦–è¦ºåŒ–å¼•æ“",
      "moduleId": 5,
      "status": "notdone",
      "rationale": "ç›®çš„ï¼šå°‡è¤‡é›œçš„é‚è¼¯æ¨æ¼”è½‰åŒ–ç‚ºç›´è§€çš„åœ–è¡¨ï¼ŒåŠ é€Ÿè³‡è¨Šå¸æ”¶ã€‚\næŠ€è¡“/åŠŸèƒ½å¯¦ç¾ï¼šå‰ç«¯æ¸²æŸ“å¼•æ“ï¼Œè² è²¬ç¹ªè£½å‹•æ…‹çš„æ¨è«–éˆ (Tree View) èˆ‡çŸ¥è­˜åœ–è­œ (Knowledge Graph)ï¼Œæ”¯æ´ç¸®æ”¾èˆ‡é»æ“Šäº’å‹•ã€‚",
      "script": "output/visualizer_engine.py",
      "x": 3408,
      "y": 646,
      "workflows": [
        "workflow5"
      ]
    },
    {
      "id": "graph-editor",
      "labelEn": "Graph Editor",
      "labelZh": "åœ–è­œç·¨è¼¯å™¨",
      "moduleId": 5,
      "status": "notdone",
      "rationale": "ç›®çš„ï¼šè®“ä½¿ç”¨è€…èƒ½åƒèˆ‡çŸ¥è­˜å»ºæ§‹ï¼Œå°‡ AI æˆæœè½‰åŒ–ç‚ºå€‹äººçŸ¥è­˜è³‡ç”¢ã€‚\næŠ€è¡“/åŠŸèƒ½å¯¦ç¾ï¼šæä¾›äº’å‹•å¼ç·¨è¼¯å·¥å…·ï¼Œå…è¨±ä½¿ç”¨è€…å°çŸ¥è­˜åœ–è­œé€²è¡Œç¯€é»æ–°å¢ã€è¨»é‡‹ä¿®æ”¹èˆ‡é—œè¯èª¿æ•´ã€‚",
      "script": "output/graph_editor.py",
      "x": 3381,
      "y": 822,
      "workflows": [
        "workflow5"
      ]
    },
    {
      "id": "dashboard-ui",
      "labelEn": "Dashboard UI",
      "labelZh": "å„€è¡¨æ¿ä»‹é¢",
      "moduleId": 5,
      "status": "notdone",
      "rationale": "ç›®çš„ï¼šç‚ºåª’é«”èˆ‡ä¼æ¥­æä¾›æ±ºç­–è¼”åŠ©ï¼ŒæŒæ¡è­°é¡Œè¶¨å‹¢èˆ‡æˆæ•ˆã€‚\næŠ€è¡“/åŠŸèƒ½å¯¦ç¾ï¼šè¦–è¦ºåŒ–æ•¸æ“šçœ‹æ¿ï¼Œå±•ç¤ºç†±é–€é—œéµå­—ã€è®€è€…åˆ†ç¾¤ã€å°æµè½‰æ›ç‡ç­‰é—œéµæŒ‡æ¨™ã€‚",
      "script": "output/dashboard_ui.py",
      "x": 3642,
      "y": 647,
      "workflows": [
        "workflow5"
      ]
    },
    {
      "id": "source-collab-mgr",
      "labelEn": "Source & Collab Mgr",
      "labelZh": "ä¾†æºå”ä½œç®¡ç†",
      "moduleId": 5,
      "status": "notdone",
      "rationale": "ç›®çš„ï¼šæä¾›éˆæ´»çš„è³‡æ–™æ²»ç†èˆ‡åœ˜éšŠå”ä½œç’°å¢ƒã€‚\næŠ€è¡“/åŠŸèƒ½å¯¦ç¾ï¼šç®¡ç†ä»‹é¢ï¼Œæ”¯æ´è³‡æ–™ä¾†æºé–‹é—œ (Domain Allowlist)ã€åœ˜éšŠæˆå“¡æ¬Šé™è¨­å®šåŠå”ä½œç‰ˆæœ¬æ§åˆ¶ã€‚",
      "script": "output/source_collab_manager.py",
      "x": 3156,
      "y": 650,
      "workflows": [
        "workflow5"
      ]
    },
    {
      "id": "export-service",
      "labelEn": "Export Service",
      "labelZh": "åŒ¯å‡ºæœå‹™",
      "moduleId": 5,
      "status": "partial",
      "rationale": "ç›®çš„ï¼šæ‰“ç ´å·¥å…·è—©ç±¬ï¼Œè®“ AI ç”¢å‡ºèƒ½ç›´æ¥æ‡‰ç”¨æ–¼å ±å‘Šèˆ‡ç°¡å ±ã€‚\næŠ€è¡“/åŠŸèƒ½å¯¦ç¾ï¼šæ”¯æ´å°‡å°è©±èˆ‡åœ–è­œåŒ¯å‡ºç‚º Wordã€PPTã€Excel æ ¼å¼ï¼Œæˆ–ç”Ÿæˆåˆ†äº«é€£çµï¼Œè®“ä½¿ç”¨è€…å¸¶åˆ°è‡ªå·±ç¿’æ…£çš„ç­†è¨˜è»Ÿé«”æˆ–AIå·¥å…·ï¼Œç¹¼çºŒè™•ç†è³‡æ–™ã€‚",
      "script": "",
      "x": 2883,
      "y": 649,
      "workflows": [
        "workflow5"
      ],
      "isModuleHeader": false
    },
    {
      "id": "mod-infrastructure",
      "labelEn": "Infrastructure",
      "labelZh": "åŸºç¤è¨­æ–½",
      "moduleId": 6,
      "status": "header",
      "rationale": "æ­¤å€å¡ŠåŒ…å«æ”¯æ’å…¨ç³»çµ±é‹ä½œçš„åº•å±¤æ ¸å¿ƒæœå‹™ï¼Œç‚ºæ‰€æœ‰æ¨¡çµ„æä¾›ç®—åŠ›èˆ‡æ•¸æ“šæ”¯æŒï¼Œç¢ºä¿ç³»çµ±çš„é«˜å¯ç”¨æ€§èˆ‡å¯è§€æ¸¬æ€§ã€‚",
      "script": "",
      "isModuleHeader": true,
      "x": 957,
      "y": 35,
      "workflows": [
        "workflow1",
        "workflow5"
      ]
    },
    {
      "id": "sys-llm",
      "labelEn": "LLM Service",
      "labelZh": "LLMæœå‹™",
      "moduleId": 6,
      "status": "done",
      "rationale": "ç›®çš„ï¼šæä¾›å…¨ç³»çµ±é€šç”¨çš„é«˜éšèªçŸ¥èˆ‡ç”Ÿæˆèƒ½åŠ›ã€‚\næŠ€è¡“/åŠŸèƒ½å¯¦ç¾ï¼šå°è£å¤šç¨®æ¨¡å‹ (GPT-4/Claude) APIï¼Œçµ±ä¸€ç®¡ç† Token é ç®—èˆ‡ Context Windowï¼Œæœå‹™å…¨ç³»çµ±å„æ¨¡çµ„ã€‚",
      "script": "core/llm_client.py",
      "x": 2078,
      "y": 86,
      "workflows": [
        "workflow1",
        "workflow4",
        "workflow5"
      ]
    },
    {
      "id": "sys-ana",
      "labelEn": "Analytics Engine",
      "labelZh": "åˆ†æå¼•æ“",
      "moduleId": 6,
      "status": "done",
      "rationale": "ç›®çš„ï¼šé©…å‹•ç”¢å“å„ªåŒ–çš„æ•¸æ“šå¤§è…¦ï¼Œå¯¦ç¾æ•¸æ“šé©…å‹•çš„æ±ºç­–ã€‚\næŠ€è¡“/åŠŸèƒ½å¯¦ç¾ï¼šå…¨åŸŸæ•¸æ“šæ”¶é›†å™¨ï¼Œè¿½è¹¤æª¢ç´¢å“è³ªã€Ranking æ¬Šé‡åˆ†ä½ˆèˆ‡ä½¿ç”¨è€…äº’å‹•è¡Œç‚ºï¼Œç‚º Dashboard æä¾›é‹ç®—åŸºç¤ï¼Œä¸¦æ”¯æ´é—œéµå­—è¿½è¹¤é€šçŸ¥ã€‚",
      "script": "core/query_logger.py",
      "x": 1409,
      "y": 83,
      "workflows": [
        "workflow5"
      ]
    },
    {
      "id": "node-1765349715587",
      "labelEn": "Multi-search Integrator",
      "labelZh": "å¤šä¾†æºæœå°‹æ•´åˆ",
      "status": "notdone",
      "script": "core/integrator.py",
      "rationale": "",
      "moduleId": 2,
      "isModuleHeader": false,
      "workflows": [
        "workflow5"
      ],
      "x": 1367,
      "y": 967
    }
  ],
  "edges": [
    {
      "from": "sys-api",
      "to": "knowledge-gap"
    },
    {
      "from": "sys-vec",
      "to": "internal-index"
    },
    {
      "from": "xgboost",
      "to": "mmr"
    },
    {
      "from": "synthesis",
      "to": "sys-api"
    },
    {
      "from": "sys-api",
      "to": "sys-fe"
    },
    {
      "from": "llm-weight",
      "to": "rule-weight"
    },
    {
      "from": "rule-weight",
      "to": "xgboost"
    },
    {
      "from": "domain-allowlist",
      "to": "auto-crawler"
    },
    {
      "from": "auto-crawler",
      "to": "regex-parser"
    },
    {
      "from": "regex-parser",
      "to": "quality-gate"
    },
    {
      "from": "quality-gate",
      "to": "light-ner"
    },
    {
      "from": "light-ner",
      "to": "data-chunking"
    },
    {
      "from": "anomaly-detector",
      "to": "auto-crawler"
    },
    {
      "from": "auto-crawler",
      "to": "format-detect"
    },
    {
      "from": "src-auth",
      "to": "auto-crawler"
    },
    {
      "from": "format-detect",
      "to": "quality-gate"
    },
    {
      "from": "data-chunking",
      "to": "sys-vec"
    },
    {
      "from": "prompt-guardrails",
      "to": "query-decomp"
    },
    {
      "from": "upload-gateway",
      "to": "sys-vec"
    },
    {
      "from": "query-decomp",
      "to": "internal-index"
    },
    {
      "from": "query-decomp",
      "to": "web-search"
    },
    {
      "from": "query-decomp",
      "to": "multi-source"
    },
    {
      "from": "internal-index",
      "to": "node-1765349715587"
    },
    {
      "from": "web-search",
      "to": "node-1765349715587"
    },
    {
      "from": "multi-source",
      "to": "node-1765349715587"
    },
    {
      "from": "sys-db",
      "to": "sys-ana"
    },
    {
      "from": "sqlite-dev",
      "to": "sys-ana"
    },
    {
      "from": "sys-ana",
      "to": "user-data"
    },
    {
      "from": "node-1765349715587",
      "to": "llm-weight"
    },
    {
      "from": "orchestrator",
      "to": "clarification-agent"
    },
    {
      "from": "orchestrator",
      "to": "analyst-agent"
    },
    {
      "from": "clarification-agent",
      "to": "analyst-agent"
    },
    {
      "from": "kg-logic",
      "to": "analyst-agent"
    },
    {
      "from": "analyst-agent",
      "to": "kg-logic"
    },
    {
      "from": "gap-analysis",
      "to": "analyst-agent"
    },
    {
      "from": "analyst-agent",
      "to": "gap-analysis"
    },
    {
      "from": "analyst-agent",
      "to": "critic-agent"
    },
    {
      "from": "critic-agent",
      "to": "writer-agent"
    }
  ],
  "moduleBoxes": [
    {
      "x": 12,
      "y": 222,
      "width": 849,
      "height": 959,
      "moduleId": 0,
      "nodePositions": [
        {
          "id": "mod-indexing",
          "offsetX": 10,
          "offsetY": 10
        },
        {
          "id": "sys-vec",
          "offsetX": 581,
          "offsetY": 662
        },
        {
          "id": "data-chunking",
          "offsetX": 300,
          "offsetY": 836
        },
        {
          "id": "auto-crawler",
          "offsetX": 290,
          "offsetY": 270
        },
        {
          "id": "format-detect",
          "offsetX": 417,
          "offsetY": 407
        },
        {
          "id": "quality-gate",
          "offsetX": 300,
          "offsetY": 545
        },
        {
          "id": "light-ner",
          "offsetX": 298,
          "offsetY": 690
        },
        {
          "id": "src-auth",
          "offsetX": 534,
          "offsetY": 138
        },
        {
          "id": "domain-allowlist",
          "offsetX": 20,
          "offsetY": 137
        },
        {
          "id": "regex-parser",
          "offsetX": 175,
          "offsetY": 407
        },
        {
          "id": "anomaly-detector",
          "offsetX": 287,
          "offsetY": 143
        }
      ]
    },
    {
      "x": 943,
      "y": 272,
      "width": 469,
      "height": 371,
      "moduleId": 1,
      "nodePositions": [
        {
          "id": "mod-input",
          "offsetX": 126,
          "offsetY": 8
        },
        {
          "id": "prompt-guardrails",
          "offsetX": 21,
          "offsetY": 109
        },
        {
          "id": "upload-gateway",
          "offsetX": 18,
          "offsetY": 222
        },
        {
          "id": "query-decomp",
          "offsetX": 254,
          "offsetY": 214
        }
      ]
    },
    {
      "x": 925,
      "y": 718,
      "width": 680,
      "height": 389,
      "moduleId": 2,
      "nodePositions": [
        {
          "id": "mod-retrieval",
          "offsetX": 9,
          "offsetY": 286
        },
        {
          "id": "internal-index",
          "offsetX": 21,
          "offsetY": 41
        },
        {
          "id": "web-search",
          "offsetX": 433,
          "offsetY": 42
        },
        {
          "id": "multi-source",
          "offsetX": 226,
          "offsetY": 40
        },
        {
          "id": "node-1765349715587",
          "offsetX": 240,
          "offsetY": 269
        }
      ]
    },
    {
      "x": 1784,
      "y": 344,
      "width": 299,
      "height": 773,
      "moduleId": 3,
      "nodePositions": [
        {
          "id": "mod-ranking",
          "offsetX": 10,
          "offsetY": 10
        },
        {
          "id": "mmr",
          "offsetX": 19,
          "offsetY": 477
        },
        {
          "id": "xgboost",
          "offsetX": 22,
          "offsetY": 354
        },
        {
          "id": "rule-weight",
          "offsetX": 22,
          "offsetY": 231
        },
        {
          "id": "llm-weight",
          "offsetX": 20,
          "offsetY": 110
        }
      ]
    },
    {
      "x": 2165,
      "y": 342,
      "width": 551,
      "height": 856,
      "moduleId": 4,
      "nodePositions": [
        {
          "id": "mod-reasoning",
          "offsetX": 10,
          "offsetY": 10
        },
        {
          "id": "knowledge-boundary",
          "offsetX": 220,
          "offsetY": 120
        },
        {
          "id": "knowledge-gap",
          "offsetX": 455,
          "offsetY": 507
        },
        {
          "id": "iterative-search",
          "offsetX": 430,
          "offsetY": 648
        },
        {
          "id": "domain-classifier",
          "offsetX": 10,
          "offsetY": 120
        },
        {
          "id": "logic-verify",
          "offsetX": 430,
          "offsetY": 120
        },
        {
          "id": "logic-transparency",
          "offsetX": 118,
          "offsetY": 608
        },
        {
          "id": "knowledge-graph",
          "offsetX": 220,
          "offsetY": 450
        },
        {
          "id": "synthesis",
          "offsetX": 182,
          "offsetY": 286
        }
      ]
    },
    {
      "x": 2862,
      "y": 339,
      "width": 1034,
      "height": 815,
      "moduleId": 5,
      "nodePositions": [
        {
          "id": "mod-output",
          "offsetX": 10,
          "offsetY": 10
        },
        {
          "id": "sys-api",
          "offsetX": 256,
          "offsetY": 11
        },
        {
          "id": "sys-fe",
          "offsetX": 163,
          "offsetY": 142
        },
        {
          "id": "llm-safety-net",
          "offsetX": 393,
          "offsetY": 144
        },
        {
          "id": "visualizer-engine",
          "offsetX": 521,
          "offsetY": 329
        },
        {
          "id": "graph-editor",
          "offsetX": 519,
          "offsetY": 479
        },
        {
          "id": "dashboard-ui",
          "offsetX": 13,
          "offsetY": 543
        },
        {
          "id": "source-collab-mgr",
          "offsetX": 294,
          "offsetY": 307
        },
        {
          "id": "export-service",
          "offsetX": 40,
          "offsetY": 300
        }
      ]
    },
    {
      "x": 943,
      "y": 20,
      "width": 1705,
      "height": 227,
      "moduleId": 6
    }
  ]
};
        console.log('Loaded architecture data:', graphData);

        // Initialize moduleId for each moduleBox (box index = moduleId)
        if (graphData.moduleBoxes) {
            graphData.moduleBoxes.forEach((box, index) => {
                box.moduleId = index;
            });
        }

        initializeUI();
        drawGraph();

        function initializeUI() {
            // Workflow buttons
            document.querySelectorAll('.workflow-btn').forEach(btn => {
                btn.addEventListener('click', () => switchWorkflow(btn.dataset.workflow));
            });

            // Edit mode button
            document.getElementById('edit-mode-btn').addEventListener('click', toggleEditMode);

            // Add node button
            document.getElementById('add-node-btn').addEventListener('click', () => openEditModal(null));

            // Save layout button
            document.getElementById('save-layout-btn').addEventListener('click', saveLayoutToHTML);

            // Import button
            document.getElementById('import-btn').addEventListener('click', () => {
                document.getElementById('import-file-input').click();
            });
            document.getElementById('import-file-input').addEventListener('change', importJSON);

            // Export button
            document.getElementById('export-btn').addEventListener('click', exportJSON);

            // Modal buttons
            document.getElementById('cancel-btn').addEventListener('click', closeEditModal);
            document.getElementById('delete-btn').addEventListener('click', deleteNode);
            document.getElementById('edit-form').addEventListener('submit', saveNode);

            // Close modal on overlay click
            document.getElementById('edit-modal').addEventListener('click', (e) => {
                if (e.target.id === 'edit-modal') closeEditModal();
            });

            // Populate module dropdown
            populateModuleDropdown();

            // Status change handler
            document.getElementById('input-status').addEventListener('change', updateModuleVisibility);
        }

        function populateModuleDropdown() {
            const moduleSelect = document.getElementById('input-moduleId');
            const headerNodes = graphData.nodes.filter(n => n.isModuleHeader === true);

            moduleSelect.innerHTML = '<option value="">ç„¡ (Not assigned)</option>';
            headerNodes.forEach(node => {
                const option = document.createElement('option');
                option.value = node.moduleId;
                option.textContent = `${node.labelEn} (${node.labelZh})`;
                moduleSelect.appendChild(option);
            });
        }

        function updateModuleVisibility() {
            const status = document.getElementById('input-status').value;
            const moduleGroup = document.getElementById('module-group');
            moduleGroup.style.display = status === 'header' ? 'none' : 'block';
        }

        function toggleEditMode() {
            editMode = !editMode;
            const btn = document.getElementById('edit-mode-btn');
            const addBtn = document.getElementById('add-node-btn');
            const saveBtn = document.getElementById('save-layout-btn');
            const svg = document.getElementById('dag-canvas');

            if (editMode) {
                btn.classList.add('active');
                addBtn.classList.add('visible');
                saveBtn.classList.add('visible');
                svg.classList.add('edit-mode');
            } else {
                btn.classList.remove('active');
                addBtn.classList.remove('visible');
                saveBtn.classList.remove('visible');
                svg.classList.remove('edit-mode');
                selectedNodeForEdge = null;  // Clear selection when exiting edit mode
            }

            drawGraph();
        }

        function switchWorkflow(workflow) {
            currentWorkflow = workflow;
            document.querySelectorAll('.workflow-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.workflow === workflow);
            });
            drawGraph();
        }

        function drawGraph() {
            if (!graphData) return;

            drawModuleBoxes();
            drawEdges();
            drawNodes();
        }

        function drawModuleBoxes() {
            const boxesGroup = document.getElementById('module-boxes-group');
            boxesGroup.innerHTML = '';

            if (!graphData.moduleBoxes) return;

            graphData.moduleBoxes.forEach((box, index) => {
                const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
                g.setAttribute('class', 'module-box-group');
                g.setAttribute('data-box-index', index);

                // Module box rectangle
                const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                rect.setAttribute('class', 'module-box' + (editMode ? ' draggable' : ''));
                rect.setAttribute('x', box.x);
                rect.setAttribute('y', box.y);
                rect.setAttribute('width', box.width);
                rect.setAttribute('height', box.height);
                g.appendChild(rect);

                // Add resize handles (only in edit mode)
                if (editMode) {
                    const handleSize = 12;
                    const corners = [
                        { x: box.x - handleSize/2, y: box.y - handleSize/2, cursor: 'nw-resize', pos: 'nw' },
                        { x: box.x + box.width - handleSize/2, y: box.y - handleSize/2, cursor: 'ne-resize', pos: 'ne' },
                        { x: box.x - handleSize/2, y: box.y + box.height - handleSize/2, cursor: 'sw-resize', pos: 'sw' },
                        { x: box.x + box.width - handleSize/2, y: box.y + box.height - handleSize/2, cursor: 'se-resize', pos: 'se' }
                    ];

                    corners.forEach(corner => {
                        const handle = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                        handle.setAttribute('class', 'resize-handle');
                        handle.setAttribute('x', corner.x);
                        handle.setAttribute('y', corner.y);
                        handle.setAttribute('width', handleSize);
                        handle.setAttribute('height', handleSize);
                        handle.setAttribute('rx', '3');
                        handle.style.cursor = corner.cursor;
                        handle.setAttribute('data-corner', corner.pos);
                        g.appendChild(handle);

                        // Add resize event listeners
                        handle.addEventListener('mousedown', (e) => startResize(e, index, corner.pos));
                    });

                    // Add drag event listeners for the box
                    rect.addEventListener('mousedown', (e) => startDragBox(e, index));
                }

                boxesGroup.appendChild(g);
            });
        }

        let draggedBox = null;
        let resizingBox = null;
        let resizeCorner = null;
        let boxDragStart = { x: 0, y: 0 };
        let initialBoxState = null;

        function startDragBox(e, boxIndex) {
            e.stopPropagation();
            e.preventDefault();

            draggedBox = boxIndex;
            const box = graphData.moduleBoxes[boxIndex];

            const svg = document.getElementById('dag-canvas');
            const pt = svg.createSVGPoint();
            pt.x = e.clientX;
            pt.y = e.clientY;
            const svgP = pt.matrixTransform(svg.getScreenCTM().inverse());

            boxDragStart = { x: svgP.x - box.x, y: svgP.y - box.y };
            initialBoxState = { x: box.x, y: box.y };

            // Find all nodes with this moduleId (both Level 0 headers and Level 1 nodes)
            const moduleId = box.moduleId;
            box.nodePositions = graphData.nodes
                .filter(n => n.moduleId === moduleId)
                .map(n => ({ id: n.id, offsetX: n.x - box.x, offsetY: n.y - box.y }));
        }

        function startResize(e, boxIndex, corner) {
            e.stopPropagation();
            e.preventDefault();

            resizingBox = boxIndex;
            resizeCorner = corner;

            const box = graphData.moduleBoxes[boxIndex];
            const svg = document.getElementById('dag-canvas');
            const pt = svg.createSVGPoint();
            pt.x = e.clientX;
            pt.y = e.clientY;
            const svgP = pt.matrixTransform(svg.getScreenCTM().inverse());

            boxDragStart = { x: svgP.x, y: svgP.y };
            initialBoxState = { x: box.x, y: box.y, width: box.width, height: box.height };
        }

        // Add mousemove listener for box dragging and resizing
        document.getElementById('dag-canvas').addEventListener('mousemove', (e) => {
            if (draggedBox !== null) {
                const box = graphData.moduleBoxes[draggedBox];
                const svg = document.getElementById('dag-canvas');
                const pt = svg.createSVGPoint();
                pt.x = e.clientX;
                pt.y = e.clientY;
                const svgP = pt.matrixTransform(svg.getScreenCTM().inverse());

                const newX = Math.round(svgP.x - boxDragStart.x);
                const newY = Math.round(svgP.y - boxDragStart.y);

                const deltaX = newX - box.x;
                const deltaY = newY - box.y;

                box.x = newX;
                box.y = newY;

                // Move all contained nodes
                if (box.nodePositions) {
                    box.nodePositions.forEach(nodePos => {
                        const node = graphData.nodes.find(n => n.id === nodePos.id);
                        if (node) {
                            node.x += deltaX;
                            node.y += deltaY;
                        }
                    });
                }

                drawGraph();
            } else if (resizingBox !== null) {
                const box = graphData.moduleBoxes[resizingBox];
                const svg = document.getElementById('dag-canvas');
                const pt = svg.createSVGPoint();
                pt.x = e.clientX;
                pt.y = e.clientY;
                const svgP = pt.matrixTransform(svg.getScreenCTM().inverse());

                const deltaX = svgP.x - boxDragStart.x;
                const deltaY = svgP.y - boxDragStart.y;

                // Apply resize based on which corner
                if (resizeCorner.includes('n')) {
                    box.y = initialBoxState.y + deltaY;
                    box.height = Math.max(100, initialBoxState.height - deltaY);
                }
                if (resizeCorner.includes('s')) {
                    box.height = Math.max(100, initialBoxState.height + deltaY);
                }
                if (resizeCorner.includes('w')) {
                    box.x = initialBoxState.x + deltaX;
                    box.width = Math.max(100, initialBoxState.width - deltaX);
                }
                if (resizeCorner.includes('e')) {
                    box.width = Math.max(100, initialBoxState.width + deltaX);
                }

                drawGraph();
            }
        });

        // Add mouseup listener
        document.addEventListener('mouseup', () => {
            draggedBox = null;
            resizingBox = null;
            resizeCorner = null;
            initialBoxState = null;
        });

        function drawEdges() {
            const edgesGroup = document.getElementById('edges-group');
            edgesGroup.innerHTML = '';

            graphData.edges.forEach((edge, index) => {
                const fromNode = graphData.nodes.find(n => n.id === edge.from);
                const toNode = graphData.nodes.find(n => n.id === edge.to);

                if (!fromNode || !toNode) return;

                // Check if edge should be visible in current workflow
                const visible = currentWorkflow === 'workflow5' ||
                    (fromNode.workflows && fromNode.workflows.includes(currentWorkflow) &&
                     toNode.workflows && toNode.workflows.includes(currentWorkflow));

                const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');

                // Calculate connection points based on relative positions
                let x1, y1, x2, y2;

                const fromCenterX = fromNode.x + config.nodeWidth / 2;
                const fromCenterY = fromNode.y + config.nodeHeight / 2;
                const toCenterX = toNode.x + config.nodeWidth / 2;
                const toCenterY = toNode.y + config.nodeHeight / 2;

                const dx = toCenterX - fromCenterX;
                const dy = toCenterY - fromCenterY;

                // Determine which side of the "from" node to start from
                if (Math.abs(dx) > Math.abs(dy)) {
                    // Horizontal direction dominates
                    if (dx > 0) {
                        // Going right
                        x1 = fromNode.x + config.nodeWidth;
                        y1 = fromCenterY;
                        x2 = toNode.x;
                        y2 = toCenterY;
                    } else {
                        // Going left
                        x1 = fromNode.x;
                        y1 = fromCenterY;
                        x2 = toNode.x + config.nodeWidth;
                        y2 = toCenterY;
                    }
                } else {
                    // Vertical direction dominates
                    if (dy > 0) {
                        // Going down
                        x1 = fromCenterX;
                        y1 = fromNode.y + config.nodeHeight;
                        x2 = toCenterX;
                        y2 = toNode.y;
                    } else {
                        // Going up
                        x1 = fromCenterX;
                        y1 = fromNode.y;
                        x2 = toCenterX;
                        y2 = toNode.y + config.nodeHeight;
                    }
                }

                // Calculate control points for Bezier curve
                const midX = (x1 + x2) / 2;
                const midY = (y1 + y2) / 2;

                const d = `M ${x1} ${y1} C ${midX} ${y1}, ${midX} ${y2}, ${x2} ${y2}`;
                path.setAttribute('d', d);
                path.setAttribute('class', 'edge' + (editMode ? ' clickable' : ''));
                path.style.opacity = visible ? '1' : '0.2';
                path.setAttribute('data-edge-index', index);

                // Add click handler for edge deletion in edit mode
                if (editMode) {
                    path.addEventListener('click', (e) => {
                        e.stopPropagation();
                        deleteEdge(index);
                    });
                }

                edgesGroup.appendChild(path);
            });
        }

        function drawNodes() {
            const nodesGroup = document.getElementById('nodes-group');
            nodesGroup.innerHTML = '';

            graphData.nodes.forEach(node => {
                const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
                g.setAttribute('class', 'node' + (editMode ? ' draggable' : ''));
                g.setAttribute('data-id', node.id);

                // Check if node should be visible in current workflow
                const visible = currentWorkflow === 'workflow5' ||
                    (node.workflows && node.workflows.includes(currentWorkflow));
                g.style.opacity = visible ? '1' : '0.2';

                // Add selected class if this node is selected for edge creation
                if (selectedNodeForEdge && selectedNodeForEdge.id === node.id) {
                    g.classList.add('selected');
                }

                // Node rectangle
                const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                rect.setAttribute('class', `node-rect status-${node.status}`);
                rect.setAttribute('x', node.x);
                rect.setAttribute('y', node.y);
                rect.setAttribute('width', config.nodeWidth);
                rect.setAttribute('height', config.nodeHeight);
                g.appendChild(rect);

                // English label
                const labelEn = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                labelEn.setAttribute('class', 'node-text');
                labelEn.setAttribute('x', node.x + config.nodeWidth / 2);
                labelEn.setAttribute('y', node.y + config.nodeHeight / 2 - 15);
                labelEn.setAttribute('text-anchor', 'middle');
                labelEn.textContent = node.labelEn;
                g.appendChild(labelEn);

                // Chinese label
                const labelZh = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                labelZh.setAttribute('class', 'node-text');
                labelZh.setAttribute('x', node.x + config.nodeWidth / 2);
                labelZh.setAttribute('y', node.y + config.nodeHeight / 2 + 5);
                labelZh.setAttribute('text-anchor', 'middle');
                labelZh.textContent = node.labelZh;
                g.appendChild(labelZh);

                // Script path
                if (node.script) {
                    const script = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                    script.setAttribute('class', 'node-script');
                    script.setAttribute('x', node.x + config.nodeWidth / 2);
                    script.setAttribute('y', node.y + config.nodeHeight / 2 + 25);
                    script.setAttribute('text-anchor', 'middle');
                    script.textContent = node.script.length > 30 ? node.script.substring(0, 27) + '...' : node.script;
                    g.appendChild(script);
                }

                // Edit icon (visible only in edit mode)
                const editIcon = document.createElementNS('http://www.w3.org/2000/svg', 'g');
                editIcon.setAttribute('class', 'edit-icon');

                const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                circle.setAttribute('class', 'edit-circle');
                circle.setAttribute('cx', node.x + config.nodeWidth - 15);
                circle.setAttribute('cy', node.y + 15);
                circle.setAttribute('r', 12);
                editIcon.appendChild(circle);

                const iText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                iText.setAttribute('class', 'edit-text');
                iText.setAttribute('x', node.x + config.nodeWidth - 15);
                iText.setAttribute('y', node.y + 20);
                iText.setAttribute('text-anchor', 'middle');
                iText.textContent = 'i';
                editIcon.appendChild(iText);

                editIcon.addEventListener('click', (e) => {
                    e.stopPropagation();
                    openEditModal(node);
                });

                g.appendChild(editIcon);

                // Click to show info or handle edge creation
                g.addEventListener('click', (e) => {
                    if (editMode && e.shiftKey) {
                        // Shift + Click in edit mode: handle edge creation
                        handleNodeClickForEdge(node);
                    } else if (!editMode) {
                        // Normal mode: show info panel
                        showInfoPanel(node);
                    }
                });

                // Drag functionality
                if (editMode) {
                    g.addEventListener('mousedown', (e) => {
                        if (!e.shiftKey) {  // Only drag if not shift-clicking
                            startDrag(e, node);
                        }
                    });
                }

                nodesGroup.appendChild(g);
            });

            // Add drag listeners to SVG
            const svg = document.getElementById('dag-canvas');
            svg.addEventListener('mousemove', drag);
            svg.addEventListener('mouseup', endDrag);
        }

        function startDrag(e, node) {
            if (!editMode) return;
            draggedNode = node;
            const svg = document.getElementById('dag-canvas');
            const pt = svg.createSVGPoint();
            pt.x = e.clientX;
            pt.y = e.clientY;
            const svgP = pt.matrixTransform(svg.getScreenCTM().inverse());
            dragOffset.x = svgP.x - node.x;
            dragOffset.y = svgP.y - node.y;
            e.stopPropagation();
        }

        function drag(e) {
            if (!draggedNode) return;
            const svg = document.getElementById('dag-canvas');
            const pt = svg.createSVGPoint();
            pt.x = e.clientX;
            pt.y = e.clientY;
            const svgP = pt.matrixTransform(svg.getScreenCTM().inverse());
            draggedNode.x = Math.round(svgP.x - dragOffset.x);
            draggedNode.y = Math.round(svgP.y - dragOffset.y);
            drawGraph();
        }

        function endDrag() {
            draggedNode = null;
        }

        function showInfoPanel(node) {
            if (editMode) return; // Don't show info panel in edit mode
            const panel = document.getElementById('info-panel');
            document.getElementById('info-title').textContent = `${node.labelEn} (${node.labelZh})`;
            document.getElementById('info-content').textContent = node.rationale || 'No description available.';
            panel.style.left = Math.min(node.x + config.nodeWidth + 20, window.innerWidth - 450) + 'px';
            panel.style.top = node.y + 'px';
            panel.classList.add('visible');
        }

        function closeInfoPanel() {
            document.getElementById('info-panel').classList.remove('visible');
        }

        function openEditModal(node) {
            currentEditNode = node;
            const modal = document.getElementById('edit-modal');
            const title = document.getElementById('modal-title');
            const deleteBtn = document.getElementById('delete-btn');

            if (node) {
                // Edit existing node
                title.textContent = 'ç·¨è¼¯ç¯€é»';
                deleteBtn.style.display = 'block';
                document.getElementById('input-labelEn').value = node.labelEn || '';
                document.getElementById('input-labelZh').value = node.labelZh || '';
                document.getElementById('input-status').value = node.status || 'notdone';
                document.getElementById('input-script').value = node.script || '';
                document.getElementById('input-rationale').value = node.rationale || '';
                document.getElementById('input-moduleId').value = node.moduleId !== null && node.moduleId !== undefined ? node.moduleId : '';

                // Set workflow checkboxes
                ['workflow1', 'workflow2', 'workflow3', 'workflow4', 'workflow5'].forEach(wf => {
                    const cb = document.getElementById(wf.replace('workflow', 'wf'));
                    cb.checked = node.workflows && node.workflows.includes(wf);
                });
            } else {
                // Add new node
                title.textContent = 'æ–°å¢ç¯€é»';
                deleteBtn.style.display = 'none';
                document.getElementById('input-labelEn').value = '';
                document.getElementById('input-labelZh').value = '';
                document.getElementById('input-status').value = 'notdone';
                document.getElementById('input-script').value = '';
                document.getElementById('input-rationale').value = '';
                document.getElementById('input-moduleId').value = '';

                // Default to workflow5 only
                ['wf1', 'wf2', 'wf3', 'wf4'].forEach(id => {
                    document.getElementById(id).checked = false;
                });
                document.getElementById('wf5').checked = true;
            }

            updateModuleVisibility();
            modal.classList.add('visible');
        }

        function closeEditModal() {
            document.getElementById('edit-modal').classList.remove('visible');
            currentEditNode = null;
        }

        function saveNode(e) {
            e.preventDefault();

            const labelEn = document.getElementById('input-labelEn').value.trim();
            const labelZh = document.getElementById('input-labelZh').value.trim();
            const status = document.getElementById('input-status').value;
            const script = document.getElementById('input-script').value.trim();
            const rationale = document.getElementById('input-rationale').value.trim();
            const moduleIdValue = document.getElementById('input-moduleId').value;

            if (!labelEn || !labelZh) {
                alert('è«‹å¡«å¯«è‹±æ–‡æ¨™é¡Œå’Œä¸­æ–‡æ¨™é¡Œ');
                return;
            }

            const workflows = [];
            ['workflow1', 'workflow2', 'workflow3', 'workflow4', 'workflow5'].forEach(wf => {
                const cb = document.getElementById(wf.replace('workflow', 'wf'));
                if (cb.checked) workflows.push(wf);
            });

            if (currentEditNode) {
                // Update existing node
                currentEditNode.labelEn = labelEn;
                currentEditNode.labelZh = labelZh;
                currentEditNode.status = status;
                currentEditNode.script = script;
                currentEditNode.rationale = rationale;
                currentEditNode.moduleId = moduleIdValue ? parseInt(moduleIdValue) : null;
                currentEditNode.isModuleHeader = status === 'header';
                currentEditNode.workflows = workflows;
            } else {
                // Create new node
                const newNode = {
                    id: `node-${Date.now()}`,
                    labelEn: labelEn,
                    labelZh: labelZh,
                    status: status,
                    script: script,
                    rationale: rationale,
                    moduleId: moduleIdValue ? parseInt(moduleIdValue) : null,
                    isModuleHeader: status === 'header',
                    workflows: workflows,
                    x: 500,
                    y: 500
                };
                graphData.nodes.push(newNode);
            }

            closeEditModal();
            drawGraph();
        }

        function deleteNode() {
            if (!currentEditNode) return;

            if (!confirm(`ç¢ºå®šè¦åˆªé™¤ç¯€é» "${currentEditNode.labelEn}" å—ï¼Ÿ\n\næ­¤æ“ä½œå°‡åŒæ™‚åˆªé™¤æ‰€æœ‰ç›¸é—œçš„é€£ç·šã€‚`)) {
                return;
            }

            // Remove node
            const nodeIndex = graphData.nodes.findIndex(n => n.id === currentEditNode.id);
            if (nodeIndex !== -1) {
                graphData.nodes.splice(nodeIndex, 1);
            }

            // Remove related edges
            graphData.edges = graphData.edges.filter(e =>
                e.from !== currentEditNode.id && e.to !== currentEditNode.id
            );

            closeEditModal();
            drawGraph();
        }

        function importJSON(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const importedData = JSON.parse(e.target.result);

                    // Validate data structure
                    if (!importedData.nodes || !Array.isArray(importedData.nodes)) {
                        throw new Error('Invalid JSON format: missing or invalid "nodes" array');
                    }
                    if (!importedData.edges || !Array.isArray(importedData.edges)) {
                        throw new Error('Invalid JSON format: missing or invalid "edges" array');
                    }

                    // Confirm before replacing
                    if (!confirm('ç¢ºå®šè¦åŒ¯å…¥æ–°çš„è³‡æ–™å—ï¼Ÿé€™æœƒå–ä»£ç›®å‰çš„æ‰€æœ‰ç¯€é»å’Œé€£ç·šã€‚')) {
                        return;
                    }

                    // Update graphData
                    graphData.nodes = importedData.nodes;
                    graphData.edges = importedData.edges;
                    graphData.moduleBoxes = importedData.moduleBoxes || [];

                    // Repopulate module dropdown
                    populateModuleDropdown();

                    // Redraw graph
                    drawGraph();

                    alert('JSON åŒ¯å…¥æˆåŠŸï¼å…±è¼‰å…¥ ' + graphData.nodes.length + ' å€‹ç¯€é»ã€‚');

                } catch (error) {
                    console.error('Import error:', error);
                    alert('åŒ¯å…¥å¤±æ•—ï¼š' + error.message);
                }
            };

            reader.onerror = () => {
                alert('è®€å–æª”æ¡ˆæ™‚ç™¼ç”ŸéŒ¯èª¤');
            };

            reader.readAsText(file);

            // Reset file input
            event.target.value = '';
        }

        function exportJSON() {
            // Remove temporary properties
            const cleanData = {
                nodes: graphData.nodes.map(n => {
                    const clean = { ...n };
                    delete clean._filtered;
                    return clean;
                }),
                edges: graphData.edges.map(e => {
                    const clean = { ...e };
                    delete clean._filtered;
                    return clean;
                }),
                moduleBoxes: graphData.moduleBoxes || []
            };

            const dataStr = JSON.stringify(cleanData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'architecture-diagram.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            alert('JSON å·²æˆåŠŸåŒ¯å‡ºï¼');
        }

        function handleNodeClickForEdge(node) {
            if (!selectedNodeForEdge) {
                // First click: select source node
                selectedNodeForEdge = node;
                drawGraph();
                console.log('Selected source node:', node.labelEn);
            } else if (selectedNodeForEdge.id === node.id) {
                // Clicked same node: deselect
                selectedNodeForEdge = null;
                drawGraph();
                console.log('Deselected node');
            } else {
                // Second click: create edge
                const newEdge = {
                    from: selectedNodeForEdge.id,
                    to: node.id
                };

                // Check if edge already exists
                const exists = graphData.edges.some(e =>
                    e.from === newEdge.from && e.to === newEdge.to
                );

                if (exists) {
                    alert('æ­¤é€£ç·šå·²ç¶“å­˜åœ¨ï¼');
                } else {
                    graphData.edges.push(newEdge);
                    console.log('Created edge:', selectedNodeForEdge.labelEn, '->', node.labelEn);
                }

                selectedNodeForEdge = null;
                drawGraph();
            }
        }

        function deleteEdge(edgeIndex) {
            const edge = graphData.edges[edgeIndex];
            const fromNode = graphData.nodes.find(n => n.id === edge.from);
            const toNode = graphData.nodes.find(n => n.id === edge.to);

            const fromLabel = fromNode ? fromNode.labelEn : edge.from;
            const toLabel = toNode ? toNode.labelEn : edge.to;

            if (confirm(`ç¢ºå®šè¦åˆªé™¤é€£ç·šå—ï¼Ÿ\n\n${fromLabel} â†’ ${toLabel}`)) {
                graphData.edges.splice(edgeIndex, 1);
                drawGraph();
                console.log('Deleted edge:', fromLabel, '->', toLabel);
            }
        }

        function saveLayoutToHTML() {
            // Prepare clean data
            const cleanData = {
                nodes: graphData.nodes.map(n => {
                    const clean = { ...n };
                    delete clean._filtered;
                    return clean;
                }),
                edges: graphData.edges.map(e => {
                    const clean = { ...e };
                    delete clean._filtered;
                    return clean;
                }),
                moduleBoxes: graphData.moduleBoxes || []
            };

            // Convert to JSON string
            const jsonString = JSON.stringify(cleanData, null, 2);

            // Create a downloadable file that user can inspect
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'layout-data-for-save.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            alert('å·²åŒ¯å‡º layout-data-for-save.json\n\nè«‹å°‡æª”æ¡ˆç§»åˆ° static/ è³‡æ–™å¤¾ï¼Œç„¶å¾ŒåŸ·è¡Œï¼š\n\ncd scripts\npython save_layout_to_html.py\n\næˆ–å¾å°ˆæ¡ˆæ ¹ç›®éŒ„åŸ·è¡Œï¼š\n\npython scripts/save_layout_to_html.py');
        }

        // Close info panel on outside click
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.info-panel') && !e.target.closest('.node')) {
                closeInfoPanel();
            }
        });
    </script>
</body>
</html>
