<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>台灣新聞 AI 搜尋引擎</title>
    <link rel="stylesheet" href="/static/news-search.css">
    <!-- D3.js for Knowledge Graph Visualization -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
</head>
<body>
    <!-- Sidebar for User Knowledge Base -->
    <div class="sidebar" id="userKnowledgeSidebar">
        <div class="sidebar-title">
            <span>📚</span>
            <span>我的知識庫</span>
        </div>

        <div class="sidebar-toggle" onclick="togglePrivateSources()">
            <input type="checkbox" id="includePrivateSourcesCheckbox" checked>
            <span class="sidebar-toggle-text">包含我的文件</span>
        </div>

        <div class="sidebar-divider"></div>

        <div class="file-list">
            <div class="file-list-title">已上傳文件</div>
            <div id="fileListContainer">
                <div style="color: #9ca3af; font-size: 13px; text-align: center; padding: 20px 0;">
                    尚未上傳文件
                </div>
            </div>
        </div>

        <button class="upload-button" onclick="triggerFileUpload()">
            <span>+</span>
            <span>上傳文件</span>
        </button>

        <input type="file" id="fileInput" style="display: none;" accept=".pdf,.docx,.txt,.md" onchange="handleFileSelect(event)">
    </div>

    <!-- Upload Progress Modal -->
    <div class="upload-modal" id="uploadModal">
        <div class="upload-modal-content">
            <div class="upload-modal-title">處理文件中...</div>
            <div class="upload-progress">
                <div class="progress-bar">
                    <div class="progress-bar-fill" id="progressBarFill" style="width: 0%"></div>
                </div>
                <div class="progress-text" id="progressText">準備上傳...</div>
            </div>
        </div>
    </div>

    <!-- Right Sidebar for Site Filter -->
    <div class="sidebar-right" id="siteFilterSidebar">
        <div class="site-filter-title">
            <span>🔍</span>
            <span>來源篩選</span>
        </div>

        <div class="site-filter-actions">
            <button class="site-filter-btn" onclick="selectAllSites()">全選</button>
            <button class="site-filter-btn" onclick="deselectAllSites()">全不選</button>
        </div>

        <div class="site-filter-list" id="siteFilterList">
            <!-- Sites will be loaded dynamically -->
            <div style="color: #9ca3af; font-size: 13px; text-align: center; padding: 20px 0;">
                載入中...
            </div>
        </div>
    </div>

    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    🔍 台灣新聞搜尋
                </div>
                <div style="display: flex; gap: 8px; align-items: center;">
                    <button class="notification-btn" id="btnNotification" title="通知">
                        🔔
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- 左側邊欄展開按鈕（固定在左側邊緣，header 下方） -->
    <button class="left-sidebar-expand-btn" id="btnExpandSidebar" title="展開對話紀錄">
        <span>▶▶▶</span>
        <span>展開對話紀錄</span>
    </button>

    <!-- ==================== 左側邊欄 ==================== -->
    <div class="left-sidebar" id="leftSidebar">
        <!-- 頂部：收回按鈕 -->
        <div class="left-sidebar-header">
            <button class="left-sidebar-collapse-btn" id="btnCollapseSidebar">
                <span>◀◀◀</span>
                <span>收回</span>
            </button>
        </div>

        <!-- 內容區 -->
        <div class="left-sidebar-content">
            <!-- 分享結果按鈕 -->
            <button class="btn-share-sidebar" id="btnShareSidebar">
                <span>🔗</span>
                <span>分享結果</span>
            </button>

            <!-- 新對話按鈕 -->
            <button class="btn-new-conversation" id="btnNewConversation">
                <span>+</span>
                <span>開啟新對話</span>
            </button>

            <!-- 歷史搜尋按鈕 -->
            <button class="btn-history-search" id="btnHistorySearch">
                <span>🔍</span>
                <span>歷史搜尋</span>
            </button>

            <!-- 資料夾/專案區塊 -->
            <div class="left-sidebar-section">
                <button class="btn-toggle-categories" id="btnToggleCategories">
                    <span>📁</span>
                    <span>開啟資料夾</span>
                </button>
            </div>

            <!-- 過往 Session 列表（自動填入） -->
            <div class="left-sidebar-divider"></div>
            <div class="left-sidebar-sessions" id="leftSidebarSessions">
                <!-- Sessions rendered dynamically -->
            </div>
        </div>

        <!-- 底部：說明與設置 -->
        <div class="left-sidebar-footer">
            <button class="btn-settings" id="btnSettings">
                <span>⚙️</span>
                <span>說明與設置</span>
            </button>
        </div>
    </div>

    <!-- ==================== 右側 Tab 面板系統 ==================== -->
    <div class="right-tabs-container" id="rightTabsContainer">
        <!-- Tab 標籤列 -->
        <div class="right-tabs-labels">
            <button class="right-tab-label" data-tab="sources">
                <span class="right-tab-label-icon">🔍</span>
                <span>來源篩選</span>
            </button>
            <button class="right-tab-label" data-tab="files">
                <span class="right-tab-label-icon">📁</span>
                <span>我的檔案</span>
            </button>
            <button class="right-tab-label" data-tab="history">
                <span class="right-tab-label-icon">📚</span>
                <span>問答紀錄</span>
            </button>
            <button class="right-tab-label" data-tab="pinned-news">
                <span class="right-tab-label-icon">📌</span>
                <span>釘選新聞</span>
            </button>
        </div>

        <!-- 來源篩選面板 -->
        <div class="right-tab-panel" id="tabPanelSources" data-tab="sources">
            <div class="right-tab-panel-header">
                <div class="right-tab-panel-title">
                    <span>🔍</span>
                    <span>來源篩選</span>
                </div>
                <button class="right-tab-panel-close" data-close-tab>&times;</button>
            </div>
            <div class="right-tab-panel-content">
                <div class="site-filter-actions">
                    <button class="site-filter-btn" onclick="selectAllSites()">全選</button>
                    <button class="site-filter-btn" onclick="deselectAllSites()">全不選</button>
                </div>
                <div class="site-filter-list" id="siteFilterListNew">
                    <div style="color: #9ca3af; font-size: 13px; text-align: center; padding: 20px 0;">
                        載入中...
                    </div>
                </div>
            </div>
        </div>

        <!-- 我的檔案面板 -->
        <div class="right-tab-panel" id="tabPanelFiles" data-tab="files">
            <div class="right-tab-panel-header">
                <div class="right-tab-panel-title">
                    <span>📁</span>
                    <span>我的檔案</span>
                </div>
                <button class="right-tab-panel-close" data-close-tab>&times;</button>
            </div>
            <div class="right-tab-panel-content">
                <div class="sidebar-toggle" onclick="togglePrivateSources()">
                    <input type="checkbox" id="includePrivateSourcesCheckboxNew" checked>
                    <span class="sidebar-toggle-text">包含我的文件</span>
                </div>
                <div style="height: 1px; background: #e5e5e5; margin: 12px 0;"></div>
                <div class="file-list">
                    <div class="file-list-title" style="font-size: 13px; font-weight: 600; color: #374151; margin-bottom: 8px;">已上傳文件</div>
                    <div id="fileListContainerNew">
                        <div style="color: #9ca3af; font-size: 13px; text-align: center; padding: 20px 0;">
                            尚未上傳文件
                        </div>
                    </div>
                </div>
                <button class="upload-button" onclick="triggerFileUpload()" style="width: 100%; margin-top: 12px; padding: 10px; background: #2563eb; color: white; border: none; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px;">
                    <span>+</span>
                    <span>上傳文件</span>
                </button>
            </div>
        </div>

        <!-- 問答紀錄面板 -->
        <div class="right-tab-panel" id="tabPanelHistory" data-tab="history">
            <div class="right-tab-panel-header">
                <div class="right-tab-panel-title">
                    <span>📚</span>
                    <span>問答紀錄</span>
                </div>
                <button class="right-tab-panel-close" data-close-tab>&times;</button>
            </div>
            <div class="right-tab-panel-content">
                <div class="saved-sessions-list" id="savedSessionsListNew" style="display: flex; flex-direction: column; gap: 8px;">
                    <!-- 問答紀錄將動態載入 -->
                </div>
            </div>
        </div>

        <!-- 釘選新聞面板 -->
        <div class="right-tab-panel" id="tabPanelPinnedNews" data-tab="pinned-news">
            <div class="right-tab-panel-header">
                <div class="right-tab-panel-title">
                    <span>📌</span>
                    <span>釘選新聞</span>
                </div>
                <button class="right-tab-panel-close" data-close-tab>&times;</button>
            </div>
            <div class="right-tab-panel-content">
                <div class="pinned-news-list" id="pinnedNewsList">
                    <div class="pinned-news-empty">尚未釘選任何新聞</div>
                </div>
            </div>
        </div>
    </div>

    <main>
        <div class="container">
            <!-- Folder/Project Page (replaces main content when active) -->
            <div class="folder-page" id="folderPage" style="display: none;">
                <!-- Folder Main View -->
                <div class="folder-main" id="folderMain">
                    <button class="folder-back-btn" id="btnFolderBackToHome">&lt; 回到搜尋</button>
                    <h1 class="folder-page-title">資料夾</h1>
                    <div class="folder-search-bar">
                        <span class="folder-search-icon">&#128269;</span>
                        <input type="text" id="folderSearchInput" placeholder="搜尋資料夾" />
                    </div>
                    <div class="folder-sort-tabs">
                        <button class="folder-sort-tab active" data-sort="all">全列表</button>
                        <button class="folder-sort-tab" data-sort="created">建立時間</button>
                        <button class="folder-sort-tab" data-sort="updated">最後更新</button>
                    </div>
                    <div class="folder-grid" id="folderGrid">
                        <!-- Folder cards rendered dynamically -->
                    </div>
                    <button class="folder-add-btn" id="btnAddFolder">+ 新增資料夾</button>
                </div>

                <!-- Folder Detail View -->
                <div class="folder-detail" id="folderDetail" style="display: none;">
                    <button class="folder-back-btn" id="btnFolderBack">&lt; 回上頁</button>
                    <h1 class="folder-detail-title" id="folderDetailTitle"></h1>
                    <div class="folder-detail-sessions" id="folderDetailSessions">
                        <!-- Sessions inside folder rendered dynamically -->
                    </div>
                </div>
            </div>

            <!-- Initial State -->
            <div class="initial-state" id="initialState">
                <h1>用自然語言搜尋最新新聞</h1>
                <p>隨時掌握事實的全貌，讓 AI 替您整理多家媒體的觀點</p>
            </div>

            <!-- Search Container -->
            <div class="search-container" id="searchContainer">
                <div class="search-box">
                    <textarea
                        class="search-input"
                        id="searchInput"
                        placeholder="問我任何新聞相關問題，例如：最近台灣資安政策有什麼進展？"
                    ></textarea>

                    <!-- 新版底部列：左側上傳、右側模式按鈕 -->
                    <div class="search-bottom-bar">
                        <div class="search-bottom-left">
                            <!-- 圖片上傳按鈕（僅在自由對話和進階搜尋模式顯示） -->
                            <button class="btn-upload-inline" id="btnUploadInline" onclick="triggerFileUpload()">
                                <span>📎</span>
                                <span>上傳檔案</span>
                            </button>
                        </div>
                        <div class="search-bottom-right">
                            <!-- 模式切換按鈕 -->
                            <div class="mode-toggle-inline" id="modeToggleInline">
                                <button class="mode-btn-inline active" data-mode="search">新聞搜尋</button>
                                <button class="mode-btn-inline" data-mode="deep_research">進階搜尋</button>
                                <button class="mode-btn-inline" data-mode="chat">自由對話</button>
                            </div>
                            <button class="btn-search" id="btnSearch">搜尋</button>
                        </div>
                    </div>

                    <!-- 進階搜尋 Popup（點擊進階搜尋按鈕時顯示） -->
                    <div class="advanced-search-popup" id="advancedSearchPopup">
                        <div class="popup-header">
                            <span class="popup-title">進階搜尋</span>
                            <button class="popup-close" id="popupClose">&times;</button>
                        </div>
                        <div class="popup-content">
                            <!-- 研究模式（3選1） -->
                            <div class="popup-section">
                                <div class="popup-section-title">研究模式:</div>
                                <div class="research-radio-group" id="researchRadioGroup">
                                    <label class="research-radio-item active" data-research-mode="discovery">
                                        <input type="radio" name="researchMode" value="discovery" checked>
                                        <div class="research-radio-content">
                                            <div class="research-radio-label">
                                                <span>🔍</span> 廣泛探索
                                            </div>
                                            <div class="research-radio-desc">包含社群/論壇 (Tier 1~5)</div>
                                        </div>
                                    </label>
                                    <label class="research-radio-item" data-research-mode="strict">
                                        <input type="radio" name="researchMode" value="strict">
                                        <div class="research-radio-content">
                                            <div class="research-radio-label">
                                                <span>🛡️</span> 嚴謹查核
                                            </div>
                                            <div class="research-radio-desc">僅官方/權威 (Tier 1~2)</div>
                                        </div>
                                    </label>
                                    <label class="research-radio-item" data-research-mode="monitor">
                                        <input type="radio" name="researchMode" value="monitor">
                                        <div class="research-radio-content">
                                            <div class="research-radio-label">
                                                <span>📡</span> 情報監測
                                            </div>
                                            <div class="research-radio-desc">比對官方與民間落差</div>
                                        </div>
                                    </label>
                                </div>
                            </div>

                            <!-- 進階設定（2個checkbox） -->
                            <div class="popup-section">
                                <div class="popup-section-title">進階設定:</div>
                                <div class="advanced-checkbox-group">
                                    <label class="advanced-checkbox-item">
                                        <input type="checkbox" id="kgToggle">
                                        <div class="advanced-checkbox-content">
                                            <div class="advanced-checkbox-label">
                                                <span>📊</span> 啟用知識圖譜
                                            </div>
                                            <div class="advanced-checkbox-hint">推論時間約 2~3 秒</div>
                                        </div>
                                    </label>
                                    <label class="advanced-checkbox-item">
                                        <input type="checkbox" id="webSearchToggle">
                                        <div class="advanced-checkbox-content">
                                            <div class="advanced-checkbox-label">
                                                <span>🌐</span> 啟用網路搜尋
                                            </div>
                                            <div class="advanced-checkbox-hint">處理系統檢索以外的資訊 3~5 秒</div>
                                        </div>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 舊版 search-actions（保留但隱藏，供 JS 相容） -->
                    <div class="search-actions" style="display: none;">
                        <div class="mode-toggle" id="modeToggle">
                            <button class="mode-button active" data-mode="search">新聞搜尋</button>
                            <button class="mode-button" data-mode="deep_research">進階搜尋</button>
                            <button class="mode-button" data-mode="chat">自由對話</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Popup 背景遮罩 -->
            <div class="popup-overlay" id="popupOverlay"></div>

            <!-- Loading State -->
            <div class="loading-state" id="loadingState">
                <div class="loading-spinner"></div>
                <div class="loading-text">🤖 正在分析您的問題...</div>
            </div>

            <!-- Results Section -->
            <div class="results-section" id="resultsSection">
                <!-- Knowledge Graph Display (Phase KG Enhanced) -->
                <div class="kg-display-container" id="kgDisplayContainer" style="display: none;">
                    <div class="kg-display-header">
                        <div class="kg-display-title">
                            <span class="kg-display-icon">📊</span>
                            <span>知識圖譜</span>
                            <span class="kg-display-metadata" id="kgMetadata"></span>
                        </div>
                        <div style="display: flex; gap: 12px; align-items: center;">
                            <!-- View Toggle -->
                            <div class="kg-view-toggle" id="kgViewToggle">
                                <button class="kg-view-btn active" data-view="graph">圖形</button>
                                <button class="kg-view-btn" data-view="list">列表</button>
                            </div>
                            <button class="kg-toggle-button" id="kgToggleButton">
                                <span id="kgToggleIcon">▼</span> 收起
                            </button>
                        </div>
                    </div>
                    <!-- Graph View -->
                    <div class="kg-graph-container" id="kgGraphView">
                        <div class="kg-tooltip" id="kgTooltip"></div>
                    </div>
                    <!-- List View -->
                    <div class="kg-display-content" id="kgDisplayContent" style="display: none;">
                        <!-- KG list content will be populated here -->
                    </div>
                    <!-- Legend -->
                    <div class="kg-legend" id="kgLegend" style="padding: 12px 20px;"></div>
                    <div class="kg-display-empty" id="kgDisplayEmpty" style="display: none;">
                        ℹ️ 此查詢不適合生成知識圖譜（例如：純粹的意見問答或單一數據查詢）
                    </div>
                </div>

                <!-- Chat Container for Free Conversation Mode -->
                <div class="chat-container" id="chatContainer">
                    <!-- Pinned Messages Banner (Line-style) -->
                    <div class="pinned-banner" id="pinnedBanner" style="display: none;">
                        <div class="pinned-banner-current" id="pinnedBannerCurrent">
                            <span class="pinned-banner-icon">📌</span>
                            <span class="pinned-banner-text" id="pinnedBannerText"></span>
                            <button class="pinned-banner-toggle" id="pinnedBannerToggle">
                                <span class="pinned-banner-count" id="pinnedBannerCount">1</span>
                                <span class="pinned-banner-arrow">▼</span>
                            </button>
                        </div>
                        <div class="pinned-banner-dropdown" id="pinnedBannerDropdown">
                            <!-- Pinned items will be populated dynamically -->
                        </div>
                    </div>
                    <div class="chat-messages" id="chatMessages">
                        <!-- Chat messages will be populated dynamically -->
                    </div>
                    <div class="chat-loading" id="chatLoading">
                        <div class="chat-loading-spinner"></div>
                        <div>AI 思考中...</div>
                    </div>
                    <div class="chat-input-container" id="chatInputContainer" style="display: none;">
                        <!-- Input will be moved here in chat mode -->
                    </div>
                </div>

                <!-- Conversation History -->
                <div class="conversation-history" id="conversationHistory" style="display: none;">
                    <div class="conversation-history-header">對話記錄</div>
                    <div class="conversation-history-list" id="conversationHistoryList">
                        <!-- History items will be populated dynamically -->
                    </div>
                </div>

                <!-- AI Summary -->
                <div class="ai-summary" id="aiSummarySection" style="display: none;">
                    <div class="ai-summary-header">
                        🤖 AI 生成摘要
                    </div>
                    <div id="aiSummaryContent">
                        <!-- Summary will be populated dynamically from API -->
                    </div>
                </div>

                <!-- View Tabs -->
                <div class="view-tabs">
                    <button class="tab active" data-view="list">列表視圖</button>
                    <button class="tab" data-view="timeline">時間軸視圖</button>
                </div>

                <!-- Summary Toggle (for both list and timeline views) -->
                <div class="summary-toggle active" id="summaryToggle">
                    <button class="btn-toggle-summary" id="btnToggleSummary">📝 展開摘要</button>
                </div>

                <!-- Summary Loading -->
                <div class="summary-loading" id="summaryLoading">
                    🤖 摘要生成中...
                </div>

                <!-- List View -->
                <div class="news-list" id="listView">
                    <!-- News cards will be populated dynamically from API -->
                </div>

                <!-- Timeline View -->
                <div class="timeline-view" id="timelineView">
                    <!-- Timeline items will be populated dynamically from API -->
                </div>

            </div>
        </div>
    </main>

    <!-- Share Modal -->
    <div class="modal-overlay" id="modalOverlay">
        <div class="modal">
            <div class="modal-header">🔗 分享這個搜尋結果</div>
            <div class="modal-content">
                <div class="modal-description">將搜尋結果複製到：</div>
                <div class="copy-options">
                    <button class="btn-copy" id="btnCopyPlainText">📋 複製摘要文字</button>
                    <button class="btn-copy" id="btnCopyChatGPT">🤖 複製並開啟 ChatGPT</button>
                    <button class="btn-copy" id="btnCopyClaude">🧑‍💻 複製並開啟 Claude</button>
                    <button class="btn-copy" id="btnCopyGemini">💎 複製並開啟 Gemini</button>
                    <button class="btn-copy" id="btnCopyNotebookLM">📓 複製並開啟 NotebookLM</button>
                </div>
                <div class="modal-tip">
                    💡 內容已包含搜尋結果和自由對話紀錄
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn-close-modal" id="btnCloseModal">關閉</button>
            </div>
        </div>
    </div>

    <!-- History Search Popup -->
    <div class="history-popup-overlay" id="historyPopupOverlay">
        <div class="history-popup">
            <div class="history-popup-header">
                <span class="history-popup-title">輸入關鍵字搜尋紀錄</span>
                <button class="history-popup-close" id="historyPopupClose">&times;</button>
            </div>
            <div class="history-popup-search">
                <input type="text" id="historyPopupSearchInput" placeholder="搜尋歷史記錄...">
            </div>
            <div class="history-popup-list" id="historyPopupList">
                <div class="history-popup-empty">尚無搜尋記錄</div>
            </div>
        </div>
    </div>

    <!-- Analytics Tracker -->
    <script src="/static/analytics-tracker-sse.js"></script>

    <!-- Marked.js for Markdown rendering -->
    <script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"></script>

    <script src="/static/news-search.js"></script>

    <!-- Phase 4: Clarification Modal -->
    <div id="clarificationModal" class="modal-overlay">
        <div class="modal" style="max-width: 600px;">
            <h2 style="margin: 0 0 16px 0; font-size: 20px; color: #111827;">需要澄清查詢內容</h2>
            <p id="clarificationHint" style="margin: 0 0 24px 0; color: #64748b; font-size: 14px;"></p>

            <div id="clarificationOptions" style="display: flex; flex-direction: column; gap: 12px; margin-bottom: 24px;">
                <!-- Options will be dynamically inserted here -->
            </div>

            <div id="clarificationFallback" style="margin-top: 16px; padding: 12px; background: #f8fafc; border-radius: 8px; font-size: 13px; color: #64748b; display: none;">
                <!-- Fallback suggestion will be inserted here -->
            </div>

            <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
                <button onclick="closeClarificationModal()" style="padding: 8px 16px; border: 1px solid #e2e8f0; border-radius: 6px; background: white; color: #64748b; cursor: pointer; font-size: 14px;">
                    取消
                </button>
            </div>
        </div>
    </div>

</body>
</html>